<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SCM – Systems in Rust</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./D0_serde.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-70c9a4798e5f6abb0636bcdc3eed0e90.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./E0_scm.html">SCM</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Systems in Rust</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_welcome.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_rustup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rustup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_hiworld.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hi world</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_hicargo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hi cargo</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_options.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Options</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_guess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guess</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_wordle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wordle</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_bits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_hamming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hamming</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_macros.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Macros</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./40_sha2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SHA-2</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./41_constants.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Constants</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./42_sha512.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SHA-512</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_754.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IEEE 754</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./51_f16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">f16</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numbers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_ix_io.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numerical I/O</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./72_ix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./80_eddsa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EdDSA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./81_python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./82_ed25519.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ed25519</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./90_stack.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stack</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./91_box.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Box</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./92_traits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Traits</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A0_graph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphs</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A1_dag.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DAG</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A2_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B0_dynamic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dynamism</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B2_lcs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LCS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C0_merkle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Merkle</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C1_heap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Heap</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C2_diff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">diff</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./D0_serde.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Serde</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E0_scm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">SCM</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#announcements" id="toc-announcements" class="nav-link active" data-scroll-target="#announcements">Announcements</a>
  <ul class="collapse">
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  <li><a href="#never" id="toc-never" class="nav-link" data-scroll-target="#never">Never</a></li>
  <li><a href="#git-example" id="toc-git-example" class="nav-link" data-scroll-target="#git-example">Git Example</a></li>
  <li><a href="#counter-proposal" id="toc-counter-proposal" class="nav-link" data-scroll-target="#counter-proposal">Counter proposal</a></li>
  <li><a href="#design-decision" id="toc-design-decision" class="nav-link" data-scroll-target="#design-decision">Design Decision</a></li>
  <li><a href="#aside-python" id="toc-aside-python" class="nav-link" data-scroll-target="#aside-python">Aside: Python</a></li>
  <li><a href="#python-quality" id="toc-python-quality" class="nav-link" data-scroll-target="#python-quality">Python Quality</a></li>
  <li><a href="#differences" id="toc-differences" class="nav-link" data-scroll-target="#differences">Differences</a></li>
  </ul></li>
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements">Requirements</a>
  <ul class="collapse">
  <li><a href="#an-scm" id="toc-an-scm" class="nav-link" data-scroll-target="#an-scm">An SCM</a></li>
  <li><a href="#a-minimal-scm" id="toc-a-minimal-scm" class="nav-link" data-scroll-target="#a-minimal-scm">A Minimal SCM</a></li>
  <li><a href="#my-terminology" id="toc-my-terminology" class="nav-link" data-scroll-target="#my-terminology">My terminology</a></li>
  <li><a href="#my-commit" id="toc-my-commit" class="nav-link" data-scroll-target="#my-commit">My Commit</a></li>
  <li><a href="#design-decisions" id="toc-design-decisions" class="nav-link" data-scroll-target="#design-decisions">Design Decisions</a></li>
  <li><a href="#get-all-files" id="toc-get-all-files" class="nav-link" data-scroll-target="#get-all-files">Get All Files</a></li>
  <li><a href="#cases" id="toc-cases" class="nav-link" data-scroll-target="#cases">Cases</a></li>
  <li><a href="#aside-.scm" id="toc-aside-.scm" class="nav-link" data-scroll-target="#aside-.scm">Aside: <code>.scm</code></a></li>
  <li><a href="#initializing" id="toc-initializing" class="nav-link" data-scroll-target="#initializing">Initializing</a></li>
  <li><a href="#subleties" id="toc-subleties" class="nav-link" data-scroll-target="#subleties">Subleties</a></li>
  <li><a href="#accessing-.scm" id="toc-accessing-.scm" class="nav-link" data-scroll-target="#accessing-.scm">Accessing <code>.scm</code></a></li>
  <li><a href="#checking-for-files" id="toc-checking-for-files" class="nav-link" data-scroll-target="#checking-for-files">Checking for files</a></li>
  <li><a href="#aside-diff" id="toc-aside-diff" class="nav-link" data-scroll-target="#aside-diff">Aside: Diff</a></li>
  <li><a href="#aside-n" id="toc-aside-n" class="nav-link" data-scroll-target="#aside-n">Aside: <code>\n</code></a></li>
  <li><a href="#build-.scm" id="toc-build-.scm" class="nav-link" data-scroll-target="#build-.scm">Build <code>.scm</code></a></li>
  <li><a href="#update-.scm" id="toc-update-.scm" class="nav-link" data-scroll-target="#update-.scm">Update <code>.scm</code></a></li>
  <li><a href="#my-revert" id="toc-my-revert" class="nav-link" data-scroll-target="#my-revert">My Revert</a></li>
  <li><a href="#today-1" id="toc-today-1" class="nav-link" data-scroll-target="#today-1">Today</a></li>
  </ul></li>
  <li><a href="#niceties" id="toc-niceties" class="nav-link" data-scroll-target="#niceties">Niceties</a>
  <ul class="collapse">
  <li><a href="#my-scrape" id="toc-my-scrape" class="nav-link" data-scroll-target="#my-scrape">My scrape</a></li>
  <li><a href="#dependency" id="toc-dependency" class="nav-link" data-scroll-target="#dependency">Dependency</a></li>
  <li><a href="#easy-mode" id="toc-easy-mode" class="nav-link" data-scroll-target="#easy-mode">Easy-mode</a></li>
  <li><a href="#recall" id="toc-recall" class="nav-link" data-scroll-target="#recall">Recall</a></li>
  <li><a href="#design-decision-1" id="toc-design-decision-1" class="nav-link" data-scroll-target="#design-decision-1">Design Decision</a></li>
  <li><a href="#today-2" id="toc-today-2" class="nav-link" data-scroll-target="#today-2">Today</a></li>
  </ul></li>
  <li><a href="#requirements-1" id="toc-requirements-1" class="nav-link" data-scroll-target="#requirements-1">Requirements</a>
  <ul class="collapse">
  <li><a href="#my-revert-1" id="toc-my-revert-1" class="nav-link" data-scroll-target="#my-revert-1">My Revert</a></li>
  <li><a href="#get-started" id="toc-get-started" class="nav-link" data-scroll-target="#get-started">Get started</a></li>
  <li><a href="#case-handling" id="toc-case-handling" class="nav-link" data-scroll-target="#case-handling">Case handling</a></li>
  <li><a href="#pop-a-commit" id="toc-pop-a-commit" class="nav-link" data-scroll-target="#pop-a-commit">Pop a commit</a></li>
  <li><a href="#this-is-gross" id="toc-this-is-gross" class="nav-link" data-scroll-target="#this-is-gross">This is gross</a></li>
  <li><a href="#clean-up" id="toc-clean-up" class="nav-link" data-scroll-target="#clean-up">Clean up</a></li>
  <li><a href="#understanding-check" id="toc-understanding-check" class="nav-link" data-scroll-target="#understanding-check">Understanding check</a></li>
  <li><a href="#answer" id="toc-answer" class="nav-link" data-scroll-target="#answer">Answer</a></li>
  <li><a href="#hint" id="toc-hint" class="nav-link" data-scroll-target="#hint">Hint</a></li>
  <li><a href="#today-3" id="toc-today-3" class="nav-link" data-scroll-target="#today-3">Today</a></li>
  </ul></li>
  <li><a href="#niceties-1" id="toc-niceties-1" class="nav-link" data-scroll-target="#niceties-1">Niceties</a>
  <ul class="collapse">
  <li><a href="#my-viewer" id="toc-my-viewer" class="nav-link" data-scroll-target="#my-viewer">My Viewer</a></li>
  <li><a href="#i-just-use-jq" id="toc-i-just-use-jq" class="nav-link" data-scroll-target="#i-just-use-jq">I just use <code>jq</code></a></li>
  <li><a href="#git-show---stat" id="toc-git-show---stat" class="nav-link" data-scroll-target="#git-show---stat"><code>git show --stat</code></a></li>
  <li><a href="#minimal" id="toc-minimal" class="nav-link" data-scroll-target="#minimal">Minimal</a></li>
  <li><a href="#today-4" id="toc-today-4" class="nav-link" data-scroll-target="#today-4">Today</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="E0_scm.rjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">SCM</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
<p class="subtitle lead">Systems in Rust</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="announcements" class="level1">
<h1>Announcements</h1>
<ul>
<li>Source Control Management
<ul>
<li>LCS / <code>diff</code> ongoing</li>
<li>Hash Trees covered, not yet deployed</li>
<li>A Pythonic (ew!) <a href="https://github.com/cd-c89/scmpy/tree/main">reference solution</a>.</li>
</ul></li>
</ul>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>Requirements
<ul class="task-list">
<li><label><input type="checkbox"><code>commit</code></label></li>
<li><label><input type="checkbox"><code>revert</code></label></li>
</ul></li>
<li>Nice-to-haves
<ul class="task-list">
<li><label><input type="checkbox"><code>viewer</code></label></li>
<li><label><input type="checkbox"><code>scrape</code></label></li>
</ul></li>
</ul>
</section>
<section id="never" class="level2">
<h2 class="anchored" data-anchor-id="never">Never</h2>
<ul>
<li>Extensions
<ul>
<li>Hashing</li>
<li>Signatures</li>
<li>Branches</li>
</ul></li>
</ul>
</section>
<section id="git-example" class="level2">
<h2 class="anchored" data-anchor-id="git-example">Git Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">$</span> tree .git</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ex">.git</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ex">├──</span> COMMIT_EDITMSG</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ex">├──</span> HEAD</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ex">├──</span> branches</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="ex">├──</span> config</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="ex">├──</span> description</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="ex">├──</span> hooks</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="ex">│&nbsp;&nbsp;</span> ├── applypatch-msg.sample</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="ex">│&nbsp;&nbsp;</span> ├── commit-msg.sample</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="ex">│&nbsp;&nbsp;</span> ├── fsmonitor-watchman.sample</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="ex">│&nbsp;&nbsp;</span> ├── post-update.sample</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-applypatch.sample</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-commit.sample</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-merge-commit.sample</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-push.sample</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-rebase.sample</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="ex">│&nbsp;&nbsp;</span> ├── pre-receive.sample</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="ex">│&nbsp;&nbsp;</span> ├── prepare-commit-msg.sample</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="ex">│&nbsp;&nbsp;</span> ├── push-to-checkout.sample</span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="ex">│&nbsp;&nbsp;</span> └── update.sample</span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="ex">├──</span> index</span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="ex">├──</span> info</span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="ex">│&nbsp;&nbsp;</span> └── exclude</span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="ex">├──</span> logs</span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="ex">│&nbsp;&nbsp;</span> ├── HEAD</span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="ex">│&nbsp;&nbsp;</span> └── refs</span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="ex">│&nbsp;&nbsp;</span>     ├── heads</span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="ex">│&nbsp;&nbsp;</span>     │&nbsp;&nbsp; └── main</span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="ex">│&nbsp;&nbsp;</span>     └── remotes</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="ex">│&nbsp;&nbsp;</span>         └── origin</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="ex">│&nbsp;&nbsp;</span>             ├── HEAD</span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="ex">│&nbsp;&nbsp;</span>             └── main</span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="ex">├──</span> objects</span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="ex">│&nbsp;&nbsp;</span> ├── 14</span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="ex">│&nbsp;&nbsp;</span> │&nbsp;&nbsp; └── 699a133ae84e6c922ca69ffa74d4df47eae49f</span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="ex">│&nbsp;&nbsp;</span> ├── 4b</span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="ex">│&nbsp;&nbsp;</span> │&nbsp;&nbsp; └── 41ec9ea0317e27beac7c2d77945e542c26f943</span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="ex">│&nbsp;&nbsp;</span> ├── a3</span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="ex">│&nbsp;&nbsp;</span> │&nbsp;&nbsp; └── 1c05f02ab1855a2f7e420ee0f5b28c2d8c1008</span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="ex">│&nbsp;&nbsp;</span> ├── b9</span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="ex">│&nbsp;&nbsp;</span> │&nbsp;&nbsp; └── 1bf6a71c95a125d9e0cd59e1149ad022b8baeb</span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="ex">│&nbsp;&nbsp;</span> ├── info</span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="ex">│&nbsp;&nbsp;</span> └── pack</span>
<span id="cb1-45"><a href="#cb1-45"></a><span class="ex">│&nbsp;&nbsp;</span>     ├── pack-6fbf46b3e979d9d021e11db53f6959e1178cbd97.idx</span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="ex">│&nbsp;&nbsp;</span>     └── pack-6fbf46b3e979d9d021e11db53f6959e1178cbd97.pack</span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="ex">├──</span> packed-refs</span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="ex">└──</span> refs</span>
<span id="cb1-49"><a href="#cb1-49"></a>    <span class="ex">├──</span> heads</span>
<span id="cb1-50"><a href="#cb1-50"></a>    <span class="ex">│&nbsp;&nbsp;</span> └── main</span>
<span id="cb1-51"><a href="#cb1-51"></a>    <span class="ex">├──</span> remotes</span>
<span id="cb1-52"><a href="#cb1-52"></a>    <span class="ex">│&nbsp;&nbsp;</span> └── origin</span>
<span id="cb1-53"><a href="#cb1-53"></a>    <span class="ex">│&nbsp;&nbsp;</span>     ├── HEAD</span>
<span id="cb1-54"><a href="#cb1-54"></a>    <span class="ex">│&nbsp;&nbsp;</span>     └── main</span>
<span id="cb1-55"><a href="#cb1-55"></a>    <span class="ex">└──</span> tags</span>
<span id="cb1-56"><a href="#cb1-56"></a></span>
<span id="cb1-57"><a href="#cb1-57"></a><span class="ex">20</span> directories, 33 files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“Everything is a file” - Linux</li>
</ul>
</section>
<section id="counter-proposal" class="level2">
<h2 class="anchored" data-anchor-id="counter-proposal">Counter proposal</h2>
<ul>
<li>Via <code>./scm.py viewer</code></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">"latest"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>      <span class="st">"#!/usr/bin/env python3"</span><span class="ot">,</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>      <span class="st">"import os, sys, json, subprocess, difflib"</span><span class="ot">,</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>      <span class="st">"SCM_NAME = </span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>      <span class="st">"DIFF_NAME = </span><span class="ch">\"</span><span class="st">.diff</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>      <span class="st">"# diff helper"</span><span class="ot">,</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>      <span class="st">"diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>      <span class="st">"# saves current version to .scm"</span><span class="ot">,</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>      <span class="st">"def commit():"</span><span class="ot">,</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>      <span class="st">"    # Get all files that aren't hidden"</span><span class="ot">,</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>      <span class="st">"    tree = [node for node in os.walk(os.getcwd()) if </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st"> not in node[0]]"</span><span class="ot">,</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>      <span class="st">"    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>      <span class="st">"    # Get or create .scm file"</span><span class="ot">,</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>      <span class="st">"    if not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0:"</span><span class="ot">,</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>      <span class="st">"        # create"</span><span class="ot">,</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>      <span class="st">"        latest = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>      <span class="st">"        json.dump("</span><span class="ot">,</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>      <span class="st">"            {</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: [{</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: {}}]},"</span><span class="ot">,</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>      <span class="st">"            open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">),"</span><span class="ot">,</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>      <span class="st">"        )"</span><span class="ot">,</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>      <span class="st">"    else:"</span><span class="ot">,</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>      <span class="st">"        # get"</span><span class="ot">,</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>      <span class="st">"        scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>      <span class="st">"        late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>      <span class="st">"        curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>      <span class="st">"        old_fs = [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">]] + [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]]"</span><span class="ot">,</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>      <span class="st">"        new_fs = [f for f in fs if fs not in old_fs]"</span><span class="ot">,</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>      <span class="st">"        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>      <span class="st">"        # We use unified diff from difflib since it still works with patch."</span><span class="ot">,</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>      <span class="st">"        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>      <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">] = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>      <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">].append({</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: init, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: diff})"</span><span class="ot">,</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>      <span class="st">"        json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>      <span class="st">"# pops latest without caching."</span><span class="ot">,</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>      <span class="st">"# not gonna ether novel files, that seems pointless?"</span><span class="ot">,</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>      <span class="st">"def scrape():"</span><span class="ot">,</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>      <span class="st">"    (not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0) and exit()"</span><span class="ot">,</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>      <span class="st">"    ["</span><span class="ot">,</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>      <span class="st">"        open(k, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>      <span class="st">"        for k, v in json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">].items()"</span><span class="ot">,</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>      <span class="st">"    ]"</span><span class="ot">,</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>      <span class="st">"# let's just roll back one, that's logically equivalent"</span><span class="ot">,</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>      <span class="st">"def revert():"</span><span class="ot">,</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>      <span class="st">"    scrape()"</span><span class="ot">,</span></span>
<span id="cb2-56"><a href="#cb2-56"></a>      <span class="st">"    scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-57"><a href="#cb2-57"></a>      <span class="st">"    late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>      <span class="st">"    curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>      <span class="st">"    len(curr) &lt; 2 and exit()"</span><span class="ot">,</span></span>
<span id="cb2-60"><a href="#cb2-60"></a>      <span class="st">"    last = curr.pop()[</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-61"><a href="#cb2-61"></a>      <span class="st">"    for k, v in last.items():"</span><span class="ot">,</span></span>
<span id="cb2-62"><a href="#cb2-62"></a>      <span class="st">"        open(DIFF_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-63"><a href="#cb2-63"></a>      <span class="st">"        os.system(</span><span class="ch">\"</span><span class="st">patch -R </span><span class="ch">\"</span><span class="st"> + k + </span><span class="ch">\"</span><span class="st"> </span><span class="ch">\"</span><span class="st"> + DIFF_NAME)"</span><span class="ot">,</span></span>
<span id="cb2-64"><a href="#cb2-64"></a>      <span class="st">"    json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-66"><a href="#cb2-66"></a>      <span class="st">"viewer = lambda: os.system("</span><span class="ot">,</span></span>
<span id="cb2-67"><a href="#cb2-67"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>      <span class="st">")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))"</span><span class="ot">,</span></span>
<span id="cb2-69"><a href="#cb2-69"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-70"><a href="#cb2-70"></a>      <span class="st">"# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-71"><a href="#cb2-71"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>      <span class="st">"# Another"</span><span class="ot">,</span></span>
<span id="cb2-73"><a href="#cb2-73"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-74"><a href="#cb2-74"></a>      <span class="st">"__name__ == </span><span class="ch">\"</span><span class="st">__main__</span><span class="ch">\"</span><span class="st"> and len(sys.argv) == 2 and {"</span><span class="ot">,</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: commit,"</span><span class="ot">,</span></span>
<span id="cb2-76"><a href="#cb2-76"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">scrape</span><span class="ch">\"</span><span class="st">: scrape,"</span><span class="ot">,</span></span>
<span id="cb2-77"><a href="#cb2-77"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-78"><a href="#cb2-78"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-79"><a href="#cb2-79"></a>      <span class="st">"}[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-80"><a href="#cb2-80"></a>      <span class="st">""</span></span>
<span id="cb2-81"><a href="#cb2-81"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-82"><a href="#cb2-82"></a>    <span class="dt">"/home/user/tmp/scmpy/scm.py.orig"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-83"><a href="#cb2-83"></a>      <span class="st">"#!/usr/bin/env python3"</span><span class="ot">,</span></span>
<span id="cb2-84"><a href="#cb2-84"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-85"><a href="#cb2-85"></a>      <span class="st">"import os, sys, json, subprocess, difflib"</span><span class="ot">,</span></span>
<span id="cb2-86"><a href="#cb2-86"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-87"><a href="#cb2-87"></a>      <span class="st">"SCM_NAME = </span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>      <span class="st">"DIFF_NAME = </span><span class="ch">\"</span><span class="st">.diff</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-89"><a href="#cb2-89"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-90"><a href="#cb2-90"></a>      <span class="st">"# diff helper"</span><span class="ot">,</span></span>
<span id="cb2-91"><a href="#cb2-91"></a>      <span class="st">"diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-92"><a href="#cb2-92"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-93"><a href="#cb2-93"></a>      <span class="st">"# saves current version to .scm"</span><span class="ot">,</span></span>
<span id="cb2-94"><a href="#cb2-94"></a>      <span class="st">"def commit():"</span><span class="ot">,</span></span>
<span id="cb2-95"><a href="#cb2-95"></a>      <span class="st">"    # Get all files that aren't hidden"</span><span class="ot">,</span></span>
<span id="cb2-96"><a href="#cb2-96"></a>      <span class="st">"    tree = [node for node in os.walk(os.getcwd()) if </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st"> not in node[0]]"</span><span class="ot">,</span></span>
<span id="cb2-97"><a href="#cb2-97"></a>      <span class="st">"    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>      <span class="st">"    # Get or create .scm file"</span><span class="ot">,</span></span>
<span id="cb2-100"><a href="#cb2-100"></a>      <span class="st">"    if not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0:"</span><span class="ot">,</span></span>
<span id="cb2-101"><a href="#cb2-101"></a>      <span class="st">"        # create"</span><span class="ot">,</span></span>
<span id="cb2-102"><a href="#cb2-102"></a>      <span class="st">"        latest = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-103"><a href="#cb2-103"></a>      <span class="st">"        json.dump("</span><span class="ot">,</span></span>
<span id="cb2-104"><a href="#cb2-104"></a>      <span class="st">"            {</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: [{</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: {}}]},"</span><span class="ot">,</span></span>
<span id="cb2-105"><a href="#cb2-105"></a>      <span class="st">"            open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">),"</span><span class="ot">,</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>      <span class="st">"        )"</span><span class="ot">,</span></span>
<span id="cb2-107"><a href="#cb2-107"></a>      <span class="st">"    else:"</span><span class="ot">,</span></span>
<span id="cb2-108"><a href="#cb2-108"></a>      <span class="st">"        # get"</span><span class="ot">,</span></span>
<span id="cb2-109"><a href="#cb2-109"></a>      <span class="st">"        scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-110"><a href="#cb2-110"></a>      <span class="st">"        late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-111"><a href="#cb2-111"></a>      <span class="st">"        curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-112"><a href="#cb2-112"></a>      <span class="st">"        old_fs = [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">]] + [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]]"</span><span class="ot">,</span></span>
<span id="cb2-113"><a href="#cb2-113"></a>      <span class="st">"        new_fs = [f for f in fs if fs not in old_fs]"</span><span class="ot">,</span></span>
<span id="cb2-114"><a href="#cb2-114"></a>      <span class="st">"        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-115"><a href="#cb2-115"></a>      <span class="st">"        # We use unified diff from difflib since it still works with patch."</span><span class="ot">,</span></span>
<span id="cb2-116"><a href="#cb2-116"></a>      <span class="st">"        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-117"><a href="#cb2-117"></a>      <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">] = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-118"><a href="#cb2-118"></a>      <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">].append({</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: init, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: diff})"</span><span class="ot">,</span></span>
<span id="cb2-119"><a href="#cb2-119"></a>      <span class="st">"        json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-120"><a href="#cb2-120"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-121"><a href="#cb2-121"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-122"><a href="#cb2-122"></a>      <span class="st">"# pops latest without caching."</span><span class="ot">,</span></span>
<span id="cb2-123"><a href="#cb2-123"></a>      <span class="st">"# not gonna ether novel files, that seems pointless?"</span><span class="ot">,</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>      <span class="st">"def scrape():"</span><span class="ot">,</span></span>
<span id="cb2-125"><a href="#cb2-125"></a>      <span class="st">"    (not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0) and exit()"</span><span class="ot">,</span></span>
<span id="cb2-126"><a href="#cb2-126"></a>      <span class="st">"    ["</span><span class="ot">,</span></span>
<span id="cb2-127"><a href="#cb2-127"></a>      <span class="st">"        open(k, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-128"><a href="#cb2-128"></a>      <span class="st">"        for k, v in json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">].items()"</span><span class="ot">,</span></span>
<span id="cb2-129"><a href="#cb2-129"></a>      <span class="st">"    ]"</span><span class="ot">,</span></span>
<span id="cb2-130"><a href="#cb2-130"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-131"><a href="#cb2-131"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-132"><a href="#cb2-132"></a>      <span class="st">"# let's just roll back one, that's logically equivalent"</span><span class="ot">,</span></span>
<span id="cb2-133"><a href="#cb2-133"></a>      <span class="st">"def revert():"</span><span class="ot">,</span></span>
<span id="cb2-134"><a href="#cb2-134"></a>      <span class="st">"    scrape()"</span><span class="ot">,</span></span>
<span id="cb2-135"><a href="#cb2-135"></a>      <span class="st">"    scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-136"><a href="#cb2-136"></a>      <span class="st">"    late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-137"><a href="#cb2-137"></a>      <span class="st">"    curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-138"><a href="#cb2-138"></a>      <span class="st">"    len(curr) &lt; 2 and exit()"</span><span class="ot">,</span></span>
<span id="cb2-139"><a href="#cb2-139"></a>      <span class="st">"    last = curr.pop()[</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-140"><a href="#cb2-140"></a>      <span class="st">"    for k, v in last.items():"</span><span class="ot">,</span></span>
<span id="cb2-141"><a href="#cb2-141"></a>      <span class="st">"        open(DIFF_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-142"><a href="#cb2-142"></a>      <span class="st">"        os.system(</span><span class="ch">\"</span><span class="st">patch -R </span><span class="ch">\"</span><span class="st"> + k + </span><span class="ch">\"</span><span class="st"> </span><span class="ch">\"</span><span class="st"> + DIFF_NAME)"</span><span class="ot">,</span></span>
<span id="cb2-143"><a href="#cb2-143"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-144"><a href="#cb2-144"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-145"><a href="#cb2-145"></a>      <span class="st">"viewer = lambda: os.system("</span><span class="ot">,</span></span>
<span id="cb2-146"><a href="#cb2-146"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-147"><a href="#cb2-147"></a>      <span class="st">")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))"</span><span class="ot">,</span></span>
<span id="cb2-148"><a href="#cb2-148"></a>      <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-149"><a href="#cb2-149"></a>      <span class="st">"__name__ == </span><span class="ch">\"</span><span class="st">__main__</span><span class="ch">\"</span><span class="st"> and len(sys.argv) == 2 and {"</span><span class="ot">,</span></span>
<span id="cb2-150"><a href="#cb2-150"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: commit,"</span><span class="ot">,</span></span>
<span id="cb2-151"><a href="#cb2-151"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">scrape</span><span class="ch">\"</span><span class="st">: scrape,"</span><span class="ot">,</span></span>
<span id="cb2-152"><a href="#cb2-152"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-153"><a href="#cb2-153"></a>      <span class="st">"    </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-154"><a href="#cb2-154"></a>      <span class="st">"}[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-155"><a href="#cb2-155"></a>      <span class="st">""</span></span>
<span id="cb2-156"><a href="#cb2-156"></a>    <span class="ot">]</span></span>
<span id="cb2-157"><a href="#cb2-157"></a>  <span class="fu">},</span></span>
<span id="cb2-158"><a href="#cb2-158"></a>  <span class="dt">"commit"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-159"><a href="#cb2-159"></a>    <span class="fu">{</span></span>
<span id="cb2-160"><a href="#cb2-160"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-161"><a href="#cb2-161"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-162"><a href="#cb2-162"></a>          <span class="st">"#!/usr/bin/env python3"</span><span class="ot">,</span></span>
<span id="cb2-163"><a href="#cb2-163"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-164"><a href="#cb2-164"></a>          <span class="st">"import os, sys, json, subprocess, difflib"</span><span class="ot">,</span></span>
<span id="cb2-165"><a href="#cb2-165"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-166"><a href="#cb2-166"></a>          <span class="st">"SCM_NAME = </span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-167"><a href="#cb2-167"></a>          <span class="st">"DIFF_NAME = </span><span class="ch">\"</span><span class="st">.diff</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-168"><a href="#cb2-168"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-169"><a href="#cb2-169"></a>          <span class="st">"# diff helper"</span><span class="ot">,</span></span>
<span id="cb2-170"><a href="#cb2-170"></a>          <span class="st">"diff_lines = lambda ls_0, ls_1: [line.strip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-171"><a href="#cb2-171"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-172"><a href="#cb2-172"></a>          <span class="st">"# saves current version to .scm"</span><span class="ot">,</span></span>
<span id="cb2-173"><a href="#cb2-173"></a>          <span class="st">"def commit():"</span><span class="ot">,</span></span>
<span id="cb2-174"><a href="#cb2-174"></a>          <span class="st">"    # Get all files that aren't hidden"</span><span class="ot">,</span></span>
<span id="cb2-175"><a href="#cb2-175"></a>          <span class="st">"    tree = [node for node in os.walk(os.getcwd()) if </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st"> not in node[0]]"</span><span class="ot">,</span></span>
<span id="cb2-176"><a href="#cb2-176"></a>          <span class="st">"    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-177"><a href="#cb2-177"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-178"><a href="#cb2-178"></a>          <span class="st">"    # Get or create .scm file"</span><span class="ot">,</span></span>
<span id="cb2-179"><a href="#cb2-179"></a>          <span class="st">"    if not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0:"</span><span class="ot">,</span></span>
<span id="cb2-180"><a href="#cb2-180"></a>          <span class="st">"        # create"</span><span class="ot">,</span></span>
<span id="cb2-181"><a href="#cb2-181"></a>          <span class="st">"        latest = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-182"><a href="#cb2-182"></a>          <span class="st">"        json.dump("</span><span class="ot">,</span></span>
<span id="cb2-183"><a href="#cb2-183"></a>          <span class="st">"            {</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: [{</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: {}}]},"</span><span class="ot">,</span></span>
<span id="cb2-184"><a href="#cb2-184"></a>          <span class="st">"            open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">),"</span><span class="ot">,</span></span>
<span id="cb2-185"><a href="#cb2-185"></a>          <span class="st">"        )"</span><span class="ot">,</span></span>
<span id="cb2-186"><a href="#cb2-186"></a>          <span class="st">"    else:"</span><span class="ot">,</span></span>
<span id="cb2-187"><a href="#cb2-187"></a>          <span class="st">"        # get"</span><span class="ot">,</span></span>
<span id="cb2-188"><a href="#cb2-188"></a>          <span class="st">"        scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-189"><a href="#cb2-189"></a>          <span class="st">"        late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-190"><a href="#cb2-190"></a>          <span class="st">"        curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-191"><a href="#cb2-191"></a>          <span class="st">"        old_fs = [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">]] + [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]]"</span><span class="ot">,</span></span>
<span id="cb2-192"><a href="#cb2-192"></a>          <span class="st">"        new_fs = [f for f in fs if fs not in old_fs]"</span><span class="ot">,</span></span>
<span id="cb2-193"><a href="#cb2-193"></a>          <span class="st">"        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-194"><a href="#cb2-194"></a>          <span class="st">"        # We use unified diff from difflib since it still works with patch."</span><span class="ot">,</span></span>
<span id="cb2-195"><a href="#cb2-195"></a>          <span class="st">"        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-196"><a href="#cb2-196"></a>          <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">] = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-197"><a href="#cb2-197"></a>          <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">].append({</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: init, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: diff})"</span><span class="ot">,</span></span>
<span id="cb2-198"><a href="#cb2-198"></a>          <span class="st">"        print(diff)"</span><span class="ot">,</span></span>
<span id="cb2-199"><a href="#cb2-199"></a>          <span class="st">"        json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-200"><a href="#cb2-200"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-201"><a href="#cb2-201"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-202"><a href="#cb2-202"></a>          <span class="st">"# pops latest without caching."</span><span class="ot">,</span></span>
<span id="cb2-203"><a href="#cb2-203"></a>          <span class="st">"# not gonna ether novel files, that seems pointless?"</span><span class="ot">,</span></span>
<span id="cb2-204"><a href="#cb2-204"></a>          <span class="st">"def scrape():"</span><span class="ot">,</span></span>
<span id="cb2-205"><a href="#cb2-205"></a>          <span class="st">"    (not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0) and exit()"</span><span class="ot">,</span></span>
<span id="cb2-206"><a href="#cb2-206"></a>          <span class="st">"    ["</span><span class="ot">,</span></span>
<span id="cb2-207"><a href="#cb2-207"></a>          <span class="st">"        open(k, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-208"><a href="#cb2-208"></a>          <span class="st">"        for k, v in json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">].items()"</span><span class="ot">,</span></span>
<span id="cb2-209"><a href="#cb2-209"></a>          <span class="st">"    ]"</span><span class="ot">,</span></span>
<span id="cb2-210"><a href="#cb2-210"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-211"><a href="#cb2-211"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-212"><a href="#cb2-212"></a>          <span class="st">"# let's just roll back one, that's logically equivalent"</span><span class="ot">,</span></span>
<span id="cb2-213"><a href="#cb2-213"></a>          <span class="st">"def revert():"</span><span class="ot">,</span></span>
<span id="cb2-214"><a href="#cb2-214"></a>          <span class="st">"    scrape()"</span><span class="ot">,</span></span>
<span id="cb2-215"><a href="#cb2-215"></a>          <span class="st">"    scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-216"><a href="#cb2-216"></a>          <span class="st">"    late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-217"><a href="#cb2-217"></a>          <span class="st">"    curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-218"><a href="#cb2-218"></a>          <span class="st">"    len(curr) &lt; 2 and exit()"</span><span class="ot">,</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>          <span class="st">"    last = curr.pop()[</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-220"><a href="#cb2-220"></a>          <span class="st">"    for k, v in last.items():"</span><span class="ot">,</span></span>
<span id="cb2-221"><a href="#cb2-221"></a>          <span class="st">"        open(DIFF_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-222"><a href="#cb2-222"></a>          <span class="st">"        os.system(</span><span class="ch">\"</span><span class="st">patch -R </span><span class="ch">\"</span><span class="st"> + k + </span><span class="ch">\"</span><span class="st"> </span><span class="ch">\"</span><span class="st"> + DIFF_NAME)"</span><span class="ot">,</span></span>
<span id="cb2-223"><a href="#cb2-223"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-224"><a href="#cb2-224"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-225"><a href="#cb2-225"></a>          <span class="st">"viewer = lambda: os.system("</span><span class="ot">,</span></span>
<span id="cb2-226"><a href="#cb2-226"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-227"><a href="#cb2-227"></a>          <span class="st">")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))"</span><span class="ot">,</span></span>
<span id="cb2-228"><a href="#cb2-228"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-229"><a href="#cb2-229"></a>          <span class="st">"__name__ == </span><span class="ch">\"</span><span class="st">__main__</span><span class="ch">\"</span><span class="st"> and len(sys.argv) == 2 and {"</span><span class="ot">,</span></span>
<span id="cb2-230"><a href="#cb2-230"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: commit,"</span><span class="ot">,</span></span>
<span id="cb2-231"><a href="#cb2-231"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">scrape</span><span class="ch">\"</span><span class="st">: scrape,"</span><span class="ot">,</span></span>
<span id="cb2-232"><a href="#cb2-232"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-233"><a href="#cb2-233"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-234"><a href="#cb2-234"></a>          <span class="st">"}[sys.argv[1]]()"</span></span>
<span id="cb2-235"><a href="#cb2-235"></a>        <span class="ot">]</span></span>
<span id="cb2-236"><a href="#cb2-236"></a>      <span class="fu">},</span></span>
<span id="cb2-237"><a href="#cb2-237"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{}</span></span>
<span id="cb2-238"><a href="#cb2-238"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-239"><a href="#cb2-239"></a>    <span class="fu">{</span></span>
<span id="cb2-240"><a href="#cb2-240"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-241"><a href="#cb2-241"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-242"><a href="#cb2-242"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-243"><a href="#cb2-243"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-244"><a href="#cb2-244"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-245"><a href="#cb2-245"></a>          <span class="st">"@@ -71,3 +71,5 @@"</span><span class="ot">,</span></span>
<span id="cb2-246"><a href="#cb2-246"></a>          <span class="st">"</span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-247"><a href="#cb2-247"></a>          <span class="st">"</span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-248"><a href="#cb2-248"></a>          <span class="st">"}[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-249"><a href="#cb2-249"></a>          <span class="st">"+"</span><span class="ot">,</span></span>
<span id="cb2-250"><a href="#cb2-250"></a>          <span class="st">"+# Trivial Comment"</span></span>
<span id="cb2-251"><a href="#cb2-251"></a>        <span class="ot">]</span></span>
<span id="cb2-252"><a href="#cb2-252"></a>      <span class="fu">}</span></span>
<span id="cb2-253"><a href="#cb2-253"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-254"><a href="#cb2-254"></a>    <span class="fu">{</span></span>
<span id="cb2-255"><a href="#cb2-255"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-256"><a href="#cb2-256"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-257"><a href="#cb2-257"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-258"><a href="#cb2-258"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-259"><a href="#cb2-259"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-260"><a href="#cb2-260"></a>          <span class="st">"@@ -6,7 +6,7 @@"</span><span class="ot">,</span></span>
<span id="cb2-261"><a href="#cb2-261"></a>          <span class="st">" DIFF_NAME = </span><span class="ch">\"</span><span class="st">.diff</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-262"><a href="#cb2-262"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-263"><a href="#cb2-263"></a>          <span class="st">" # diff helper"</span><span class="ot">,</span></span>
<span id="cb2-264"><a href="#cb2-264"></a>          <span class="st">"-diff_lines = lambda ls_0, ls_1: [line.strip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-265"><a href="#cb2-265"></a>          <span class="st">"+diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-266"><a href="#cb2-266"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-267"><a href="#cb2-267"></a>          <span class="st">" # saves current version to .scm"</span><span class="ot">,</span></span>
<span id="cb2-268"><a href="#cb2-268"></a>          <span class="st">" def commit():"</span></span>
<span id="cb2-269"><a href="#cb2-269"></a>        <span class="ot">]</span></span>
<span id="cb2-270"><a href="#cb2-270"></a>      <span class="fu">}</span></span>
<span id="cb2-271"><a href="#cb2-271"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-272"><a href="#cb2-272"></a>    <span class="fu">{</span></span>
<span id="cb2-273"><a href="#cb2-273"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-274"><a href="#cb2-274"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-275"><a href="#cb2-275"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-276"><a href="#cb2-276"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-277"><a href="#cb2-277"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-278"><a href="#cb2-278"></a>          <span class="st">"@@ -34,7 +34,6 @@"</span><span class="ot">,</span></span>
<span id="cb2-279"><a href="#cb2-279"></a>          <span class="st">"         diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-280"><a href="#cb2-280"></a>          <span class="st">"         scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">] = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-281"><a href="#cb2-281"></a>          <span class="st">"         scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">].append({</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: init, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: diff})"</span><span class="ot">,</span></span>
<span id="cb2-282"><a href="#cb2-282"></a>          <span class="st">"-        print(diff)"</span><span class="ot">,</span></span>
<span id="cb2-283"><a href="#cb2-283"></a>          <span class="st">"         json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-284"><a href="#cb2-284"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-285"><a href="#cb2-285"></a>          <span class="st">""</span></span>
<span id="cb2-286"><a href="#cb2-286"></a>        <span class="ot">]</span></span>
<span id="cb2-287"><a href="#cb2-287"></a>      <span class="fu">}</span></span>
<span id="cb2-288"><a href="#cb2-288"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-289"><a href="#cb2-289"></a>    <span class="fu">{</span></span>
<span id="cb2-290"><a href="#cb2-290"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-291"><a href="#cb2-291"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-292"><a href="#cb2-292"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-293"><a href="#cb2-293"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-294"><a href="#cb2-294"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-295"><a href="#cb2-295"></a>          <span class="st">"@@ -70,5 +70,3 @@"</span><span class="ot">,</span></span>
<span id="cb2-296"><a href="#cb2-296"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-297"><a href="#cb2-297"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-298"><a href="#cb2-298"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-299"><a href="#cb2-299"></a>          <span class="st">"-"</span><span class="ot">,</span></span>
<span id="cb2-300"><a href="#cb2-300"></a>          <span class="st">"-# Trivial Comment"</span></span>
<span id="cb2-301"><a href="#cb2-301"></a>        <span class="ot">]</span></span>
<span id="cb2-302"><a href="#cb2-302"></a>      <span class="fu">}</span></span>
<span id="cb2-303"><a href="#cb2-303"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-304"><a href="#cb2-304"></a>    <span class="fu">{</span></span>
<span id="cb2-305"><a href="#cb2-305"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-306"><a href="#cb2-306"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-307"><a href="#cb2-307"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-308"><a href="#cb2-308"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-309"><a href="#cb2-309"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-310"><a href="#cb2-310"></a>          <span class="st">"@@ -70,3 +70,7 @@"</span><span class="ot">,</span></span>
<span id="cb2-311"><a href="#cb2-311"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-312"><a href="#cb2-312"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-313"><a href="#cb2-313"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-314"><a href="#cb2-314"></a>          <span class="st">"+"</span><span class="ot">,</span></span>
<span id="cb2-315"><a href="#cb2-315"></a>          <span class="st">"+# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-316"><a href="#cb2-316"></a>          <span class="st">"+"</span><span class="ot">,</span></span>
<span id="cb2-317"><a href="#cb2-317"></a>          <span class="st">"+"</span></span>
<span id="cb2-318"><a href="#cb2-318"></a>        <span class="ot">]</span></span>
<span id="cb2-319"><a href="#cb2-319"></a>      <span class="fu">}</span></span>
<span id="cb2-320"><a href="#cb2-320"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-321"><a href="#cb2-321"></a>    <span class="fu">{</span></span>
<span id="cb2-322"><a href="#cb2-322"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-323"><a href="#cb2-323"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-324"><a href="#cb2-324"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-325"><a href="#cb2-325"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-326"><a href="#cb2-326"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-327"><a href="#cb2-327"></a>          <span class="st">"@@ -71,6 +71,5 @@"</span><span class="ot">,</span></span>
<span id="cb2-328"><a href="#cb2-328"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-329"><a href="#cb2-329"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-330"><a href="#cb2-330"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-331"><a href="#cb2-331"></a>          <span class="st">"-# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-332"><a href="#cb2-332"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-333"><a href="#cb2-333"></a>          <span class="st">""</span></span>
<span id="cb2-334"><a href="#cb2-334"></a>        <span class="ot">]</span></span>
<span id="cb2-335"><a href="#cb2-335"></a>      <span class="fu">}</span></span>
<span id="cb2-336"><a href="#cb2-336"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-337"><a href="#cb2-337"></a>    <span class="fu">{</span></span>
<span id="cb2-338"><a href="#cb2-338"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-339"><a href="#cb2-339"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py.orig"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-340"><a href="#cb2-340"></a>          <span class="st">"#!/usr/bin/env python3"</span><span class="ot">,</span></span>
<span id="cb2-341"><a href="#cb2-341"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-342"><a href="#cb2-342"></a>          <span class="st">"import os, sys, json, subprocess, difflib"</span><span class="ot">,</span></span>
<span id="cb2-343"><a href="#cb2-343"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-344"><a href="#cb2-344"></a>          <span class="st">"SCM_NAME = </span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-345"><a href="#cb2-345"></a>          <span class="st">"DIFF_NAME = </span><span class="ch">\"</span><span class="st">.diff</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-346"><a href="#cb2-346"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-347"><a href="#cb2-347"></a>          <span class="st">"# diff helper"</span><span class="ot">,</span></span>
<span id="cb2-348"><a href="#cb2-348"></a>          <span class="st">"diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]"</span><span class="ot">,</span></span>
<span id="cb2-349"><a href="#cb2-349"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-350"><a href="#cb2-350"></a>          <span class="st">"# saves current version to .scm"</span><span class="ot">,</span></span>
<span id="cb2-351"><a href="#cb2-351"></a>          <span class="st">"def commit():"</span><span class="ot">,</span></span>
<span id="cb2-352"><a href="#cb2-352"></a>          <span class="st">"    # Get all files that aren't hidden"</span><span class="ot">,</span></span>
<span id="cb2-353"><a href="#cb2-353"></a>          <span class="st">"    tree = [node for node in os.walk(os.getcwd()) if </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st"> not in node[0]]"</span><span class="ot">,</span></span>
<span id="cb2-354"><a href="#cb2-354"></a>          <span class="st">"    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != </span><span class="ch">\"</span><span class="st">.</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-355"><a href="#cb2-355"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-356"><a href="#cb2-356"></a>          <span class="st">"    # Get or create .scm file"</span><span class="ot">,</span></span>
<span id="cb2-357"><a href="#cb2-357"></a>          <span class="st">"    if not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0:"</span><span class="ot">,</span></span>
<span id="cb2-358"><a href="#cb2-358"></a>          <span class="st">"        # create"</span><span class="ot">,</span></span>
<span id="cb2-359"><a href="#cb2-359"></a>          <span class="st">"        latest = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-360"><a href="#cb2-360"></a>          <span class="st">"        json.dump("</span><span class="ot">,</span></span>
<span id="cb2-361"><a href="#cb2-361"></a>          <span class="st">"            {</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: [{</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: latest, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: {}}]},"</span><span class="ot">,</span></span>
<span id="cb2-362"><a href="#cb2-362"></a>          <span class="st">"            open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">),"</span><span class="ot">,</span></span>
<span id="cb2-363"><a href="#cb2-363"></a>          <span class="st">"        )"</span><span class="ot">,</span></span>
<span id="cb2-364"><a href="#cb2-364"></a>          <span class="st">"    else:"</span><span class="ot">,</span></span>
<span id="cb2-365"><a href="#cb2-365"></a>          <span class="st">"        # get"</span><span class="ot">,</span></span>
<span id="cb2-366"><a href="#cb2-366"></a>          <span class="st">"        scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-367"><a href="#cb2-367"></a>          <span class="st">"        late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-368"><a href="#cb2-368"></a>          <span class="st">"        curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-369"><a href="#cb2-369"></a>          <span class="st">"        old_fs = [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">]] + [f for f in curr[-1][</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]]"</span><span class="ot">,</span></span>
<span id="cb2-370"><a href="#cb2-370"></a>          <span class="st">"        new_fs = [f for f in fs if fs not in old_fs]"</span><span class="ot">,</span></span>
<span id="cb2-371"><a href="#cb2-371"></a>          <span class="st">"        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-372"><a href="#cb2-372"></a>          <span class="st">"        # We use unified diff from difflib since it still works with patch."</span><span class="ot">,</span></span>
<span id="cb2-373"><a href="#cb2-373"></a>          <span class="st">"        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}"</span><span class="ot">,</span></span>
<span id="cb2-374"><a href="#cb2-374"></a>          <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">] = {f: open(f).read().splitlines() for f in fs}"</span><span class="ot">,</span></span>
<span id="cb2-375"><a href="#cb2-375"></a>          <span class="st">"        scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">].append({</span><span class="ch">\"</span><span class="st">init</span><span class="ch">\"</span><span class="st">: init, </span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">: diff})"</span><span class="ot">,</span></span>
<span id="cb2-376"><a href="#cb2-376"></a>          <span class="st">"        json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-377"><a href="#cb2-377"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-378"><a href="#cb2-378"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-379"><a href="#cb2-379"></a>          <span class="st">"# pops latest without caching."</span><span class="ot">,</span></span>
<span id="cb2-380"><a href="#cb2-380"></a>          <span class="st">"# not gonna ether novel files, that seems pointless?"</span><span class="ot">,</span></span>
<span id="cb2-381"><a href="#cb2-381"></a>          <span class="st">"def scrape():"</span><span class="ot">,</span></span>
<span id="cb2-382"><a href="#cb2-382"></a>          <span class="st">"    (not os.path.isfile(SCM_NAME) or os.path.getsize(</span><span class="ch">\"</span><span class="st">.scm</span><span class="ch">\"</span><span class="st">) == 0) and exit()"</span><span class="ot">,</span></span>
<span id="cb2-383"><a href="#cb2-383"></a>          <span class="st">"    ["</span><span class="ot">,</span></span>
<span id="cb2-384"><a href="#cb2-384"></a>          <span class="st">"        open(k, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-385"><a href="#cb2-385"></a>          <span class="st">"        for k, v in json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">].items()"</span><span class="ot">,</span></span>
<span id="cb2-386"><a href="#cb2-386"></a>          <span class="st">"    ]"</span><span class="ot">,</span></span>
<span id="cb2-387"><a href="#cb2-387"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-388"><a href="#cb2-388"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-389"><a href="#cb2-389"></a>          <span class="st">"# let's just roll back one, that's logically equivalent"</span><span class="ot">,</span></span>
<span id="cb2-390"><a href="#cb2-390"></a>          <span class="st">"def revert():"</span><span class="ot">,</span></span>
<span id="cb2-391"><a href="#cb2-391"></a>          <span class="st">"    scrape()"</span><span class="ot">,</span></span>
<span id="cb2-392"><a href="#cb2-392"></a>          <span class="st">"    scm = json.loads(open(SCM_NAME, </span><span class="ch">\"</span><span class="st">r</span><span class="ch">\"</span><span class="st">).read())"</span><span class="ot">,</span></span>
<span id="cb2-393"><a href="#cb2-393"></a>          <span class="st">"    late = scm[</span><span class="ch">\"</span><span class="st">latest</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-394"><a href="#cb2-394"></a>          <span class="st">"    curr = scm[</span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-395"><a href="#cb2-395"></a>          <span class="st">"    len(curr) &lt; 2 and exit()"</span><span class="ot">,</span></span>
<span id="cb2-396"><a href="#cb2-396"></a>          <span class="st">"    last = curr.pop()[</span><span class="ch">\"</span><span class="st">diff</span><span class="ch">\"</span><span class="st">]"</span><span class="ot">,</span></span>
<span id="cb2-397"><a href="#cb2-397"></a>          <span class="st">"    for k, v in last.items():"</span><span class="ot">,</span></span>
<span id="cb2-398"><a href="#cb2-398"></a>          <span class="st">"        open(DIFF_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-399"><a href="#cb2-399"></a>          <span class="st">"        os.system(</span><span class="ch">\"</span><span class="st">patch -R </span><span class="ch">\"</span><span class="st"> + k + </span><span class="ch">\"</span><span class="st"> </span><span class="ch">\"</span><span class="st"> + DIFF_NAME)"</span><span class="ot">,</span></span>
<span id="cb2-400"><a href="#cb2-400"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-401"><a href="#cb2-401"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-402"><a href="#cb2-402"></a>          <span class="st">"viewer = lambda: os.system("</span><span class="ot">,</span></span>
<span id="cb2-403"><a href="#cb2-403"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-404"><a href="#cb2-404"></a>          <span class="st">")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))"</span><span class="ot">,</span></span>
<span id="cb2-405"><a href="#cb2-405"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-406"><a href="#cb2-406"></a>          <span class="st">"__name__ == </span><span class="ch">\"</span><span class="st">__main__</span><span class="ch">\"</span><span class="st"> and len(sys.argv) == 2 and {"</span><span class="ot">,</span></span>
<span id="cb2-407"><a href="#cb2-407"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: commit,"</span><span class="ot">,</span></span>
<span id="cb2-408"><a href="#cb2-408"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">scrape</span><span class="ch">\"</span><span class="st">: scrape,"</span><span class="ot">,</span></span>
<span id="cb2-409"><a href="#cb2-409"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">revert</span><span class="ch">\"</span><span class="st">: revert,"</span><span class="ot">,</span></span>
<span id="cb2-410"><a href="#cb2-410"></a>          <span class="st">"    </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-411"><a href="#cb2-411"></a>          <span class="st">"}[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-412"><a href="#cb2-412"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-413"><a href="#cb2-413"></a>          <span class="st">""</span></span>
<span id="cb2-414"><a href="#cb2-414"></a>        <span class="ot">]</span></span>
<span id="cb2-415"><a href="#cb2-415"></a>      <span class="fu">},</span></span>
<span id="cb2-416"><a href="#cb2-416"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-417"><a href="#cb2-417"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-418"><a href="#cb2-418"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-419"><a href="#cb2-419"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-420"><a href="#cb2-420"></a>          <span class="st">"@@ -58,7 +58,7 @@"</span><span class="ot">,</span></span>
<span id="cb2-421"><a href="#cb2-421"></a>          <span class="st">"     for k, v in last.items():"</span><span class="ot">,</span></span>
<span id="cb2-422"><a href="#cb2-422"></a>          <span class="st">"         open(DIFF_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">).write(</span><span class="ch">\"\\</span><span class="st">n</span><span class="ch">\"</span><span class="st">.join(v))"</span><span class="ot">,</span></span>
<span id="cb2-423"><a href="#cb2-423"></a>          <span class="st">"         os.system(</span><span class="ch">\"</span><span class="st">patch -R </span><span class="ch">\"</span><span class="st"> + k + </span><span class="ch">\"</span><span class="st"> </span><span class="ch">\"</span><span class="st"> + DIFF_NAME)"</span><span class="ot">,</span></span>
<span id="cb2-424"><a href="#cb2-424"></a>          <span class="st">"-"</span><span class="ot">,</span></span>
<span id="cb2-425"><a href="#cb2-425"></a>          <span class="st">"+    json.dump(scm, open(SCM_NAME, </span><span class="ch">\"</span><span class="st">w</span><span class="ch">\"</span><span class="st">))"</span><span class="ot">,</span></span>
<span id="cb2-426"><a href="#cb2-426"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-427"><a href="#cb2-427"></a>          <span class="st">" viewer = lambda: os.system("</span><span class="ot">,</span></span>
<span id="cb2-428"><a href="#cb2-428"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-429"><a href="#cb2-429"></a>          <span class="st">"@@ -71,5 +71,5 @@"</span><span class="ot">,</span></span>
<span id="cb2-430"><a href="#cb2-430"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-431"><a href="#cb2-431"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-432"><a href="#cb2-432"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-433"><a href="#cb2-433"></a>          <span class="st">"+# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-434"><a href="#cb2-434"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-435"><a href="#cb2-435"></a>          <span class="st">"-"</span></span>
<span id="cb2-436"><a href="#cb2-436"></a>        <span class="ot">]</span></span>
<span id="cb2-437"><a href="#cb2-437"></a>      <span class="fu">}</span></span>
<span id="cb2-438"><a href="#cb2-438"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb2-439"><a href="#cb2-439"></a>    <span class="fu">{</span></span>
<span id="cb2-440"><a href="#cb2-440"></a>      <span class="dt">"init"</span><span class="fu">:</span> <span class="fu">{},</span></span>
<span id="cb2-441"><a href="#cb2-441"></a>      <span class="dt">"diff"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-442"><a href="#cb2-442"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py.orig"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-443"><a href="#cb2-443"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-444"><a href="#cb2-444"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-445"><a href="#cb2-445"></a>          <span class="st">"@@ -71,4 +71,3 @@"</span><span class="ot">,</span></span>
<span id="cb2-446"><a href="#cb2-446"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-447"><a href="#cb2-447"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-448"><a href="#cb2-448"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-449"><a href="#cb2-449"></a>          <span class="st">"-"</span></span>
<span id="cb2-450"><a href="#cb2-450"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-451"><a href="#cb2-451"></a>        <span class="dt">"/home/user/tmp/scmpy/scm.py"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-452"><a href="#cb2-452"></a>          <span class="st">"---"</span><span class="ot">,</span></span>
<span id="cb2-453"><a href="#cb2-453"></a>          <span class="st">"+++"</span><span class="ot">,</span></span>
<span id="cb2-454"><a href="#cb2-454"></a>          <span class="st">"@@ -64,6 +64,8 @@"</span><span class="ot">,</span></span>
<span id="cb2-455"><a href="#cb2-455"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">jq . .scm</span><span class="ch">\"</span><span class="st">"</span><span class="ot">,</span></span>
<span id="cb2-456"><a href="#cb2-456"></a>          <span class="st">" )  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))"</span><span class="ot">,</span></span>
<span id="cb2-457"><a href="#cb2-457"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-458"><a href="#cb2-458"></a>          <span class="st">"+# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-459"><a href="#cb2-459"></a>          <span class="st">"+"</span><span class="ot">,</span></span>
<span id="cb2-460"><a href="#cb2-460"></a>          <span class="st">" __name__ == </span><span class="ch">\"</span><span class="st">__main__</span><span class="ch">\"</span><span class="st"> and len(sys.argv) == 2 and {"</span><span class="ot">,</span></span>
<span id="cb2-461"><a href="#cb2-461"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">commit</span><span class="ch">\"</span><span class="st">: commit,"</span><span class="ot">,</span></span>
<span id="cb2-462"><a href="#cb2-462"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">scrape</span><span class="ch">\"</span><span class="st">: scrape,"</span><span class="ot">,</span></span>
<span id="cb2-463"><a href="#cb2-463"></a>          <span class="st">"@@ -71,9 +73,3 @@"</span><span class="ot">,</span></span>
<span id="cb2-464"><a href="#cb2-464"></a>          <span class="st">"     </span><span class="ch">\"</span><span class="st">viewer</span><span class="ch">\"</span><span class="st">: viewer,"</span><span class="ot">,</span></span>
<span id="cb2-465"><a href="#cb2-465"></a>          <span class="st">" }[sys.argv[1]]()"</span><span class="ot">,</span></span>
<span id="cb2-466"><a href="#cb2-466"></a>          <span class="st">""</span><span class="ot">,</span></span>
<span id="cb2-467"><a href="#cb2-467"></a>          <span class="st">"-# Trivial Comment"</span><span class="ot">,</span></span>
<span id="cb2-468"><a href="#cb2-468"></a>          <span class="st">"-"</span><span class="ot">,</span></span>
<span id="cb2-469"><a href="#cb2-469"></a>          <span class="st">"-# Another"</span><span class="ot">,</span></span>
<span id="cb2-470"><a href="#cb2-470"></a>          <span class="st">"-"</span><span class="ot">,</span></span>
<span id="cb2-471"><a href="#cb2-471"></a>          <span class="st">"-"</span><span class="ot">,</span></span>
<span id="cb2-472"><a href="#cb2-472"></a>          <span class="st">"-"</span></span>
<span id="cb2-473"><a href="#cb2-473"></a>        <span class="ot">]</span></span>
<span id="cb2-474"><a href="#cb2-474"></a>      <span class="fu">}</span></span>
<span id="cb2-475"><a href="#cb2-475"></a>    <span class="fu">}</span></span>
<span id="cb2-476"><a href="#cb2-476"></a>  <span class="ot">]</span></span>
<span id="cb2-477"><a href="#cb2-477"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="design-decision" class="level2">
<h2 class="anchored" data-anchor-id="design-decision">Design Decision</h2>
<blockquote class="blockquote">
<p>Decide whether you want to navigate a file system and crush text and be rad as heck, or learn <code>serde</code>, toss everything in a single file, and be cool as heck</p>
</blockquote>
<ul>
<li>I liked JSON a lot for this, but there’s no question there’s benefits to using the file system!
<ul>
<li>But… what if you <em>don’t have a file system</em> (is that CS-371: Operating Systems’ theme?)</li>
</ul></li>
</ul>
</section>
<section id="aside-python" class="level2">
<h2 class="anchored" data-anchor-id="aside-python">Aside: Python</h2>
<ul>
<li>Python is cringe or bad or whatever, I just used a language you knew to give a reference that is “self-documentating”.</li>
<li>It also makes a few system calls, directly using <code>patch</code> for example (this will probably explode on Windows, which is a you-problem).</li>
</ul>
</section>
<section id="python-quality" class="level2">
<h2 class="anchored" data-anchor-id="python-quality">Python Quality</h2>
<ul>
<li>I also put some effort into making the Python “look like Python” so all examples here are:
<ul>
<li>Open source.</li>
<li>Licensed GPLv3 (ask me after class)</li>
<li><a href="https://github.com/psf/black"><code>black</code></a> formatted.</li>
</ul></li>
</ul>
</section>
<section id="differences" class="level2">
<h2 class="anchored" data-anchor-id="differences">Differences</h2>
<ul>
<li>You shouldn’t use system calls like <code>patch</code>
<ul>
<li>Those aren’t written in Rust, and therefore we can’t use them.</li>
</ul></li>
<li>You are writing actually usable code and should use a license and <code>cargo fmt</code>
<ul>
<li>You’ll see why formatting is so nice as soon as you start looking a SCM diffs!</li>
</ul></li>
</ul>
</section>
</section>
<section id="requirements" class="level1">
<h1>Requirements</h1>
<section id="an-scm" class="level2">
<h2 class="anchored" data-anchor-id="an-scm">An SCM</h2>
<blockquote class="blockquote">
<p><a href="https://en.wikipedia.org/wiki/Version_control">Version control (also known as revision control, source control, and source code management) is the software engineering practice of controlling, organizing, and tracking different versions in history of computer files; primarily source code text files, but generally any type of file.</a></p>
</blockquote>
</section>
<section id="a-minimal-scm" class="level2">
<h2 class="anchored" data-anchor-id="a-minimal-scm">A Minimal SCM</h2>
<blockquote class="blockquote">
<p>Version control includes options to view old versions and to revert a file to a previous version.</p>
</blockquote>
<ul>
<li>For the final, we implement an SCM that does two things:
<ul>
<li>Saves old versions of files, somehow</li>
<li>Can “roll back” changes to files to older versions.</li>
<li>Provides some form of visibility into past files</li>
</ul></li>
</ul>
</section>
<section id="my-terminology" class="level2">
<h2 class="anchored" data-anchor-id="my-terminology">My terminology</h2>
<ul>
<li>I use the following verbs, ish, to describe these:
<ul>
<li><code>commit</code> saves the current version of the files under control/management</li>
<li><code>revert</code> overwrites the <em>current</em> version with the <em>previous</em> version.</li>
</ul></li>
<li>I am not a pretty-print enthusiast and simply dump JSON unaltered to meet the “visibility” requirement.
<ul>
<li>This can be a fun thing to extend to look nicer if you want!</li>
<li>Check out e.g.&nbsp;<code>git log</code></li>
</ul></li>
</ul>
</section>
<section id="my-commit" class="level2">
<h2 class="anchored" data-anchor-id="my-commit">My Commit</h2>
<ul>
<li>Read every non-hidden (non-<code>.</code> prefixed) file and folder in the current path, recursively.</li>
<li>Check to see if the system is already under version control by checking for a <code>.scm</code> file
<ul>
<li>In the case the file (vs.&nbsp;JSON) implementation, this would be a folder, like <code>.git</code></li>
</ul></li>
<li>Either create a JSON file containing all file contents if <code>.scm</code> does not exist, or</li>
<li>Append a diff to the JSON file for every change.</li>
</ul>
</section>
<section id="design-decisions" class="level2">
<h2 class="anchored" data-anchor-id="design-decisions">Design Decisions</h2>
<ul>
<li>This is not a <code>git commit</code>!</li>
<li>Git has both <code>init</code> and <code>add</code> - I use neither
<ul>
<li>The first time commit is called, it runs an initializer instead of a standard commit.</li>
<li>All files are automatically included.</li>
</ul></li>
<li>You don’t have to do either of these, but should probably provide an alias to similar to <code>./scm.py commit</code> just to test equivalencies.</li>
</ul>
</section>
<section id="get-all-files" class="level2">
<h2 class="anchored" data-anchor-id="get-all-files">Get All Files</h2>
<ul>
<li>I didn’t even initially include commit in a function since it was the first thing I wrote!</li>
<li>But now, it starts like this:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Get all files that aren't hidden</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>tree <span class="op">=</span> [node <span class="cf">for</span> node <span class="kw">in</span> os.walk(os.getcwd()) <span class="cf">if</span> <span class="st">"."</span> <span class="kw">not</span> <span class="kw">in</span> node[<span class="dv">0</span>]]</span>
<span id="cb3-3"><a href="#cb3-3"></a>fs <span class="op">=</span> [os.path.join(node[<span class="dv">0</span>], n) <span class="cf">for</span> node <span class="kw">in</span> tree <span class="cf">for</span> n <span class="kw">in</span> node[<span class="dv">2</span>] <span class="cf">if</span> n[<span class="dv">0</span>] <span class="op">!=</span> <span class="st">"."</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>fs</code> is the Python list (so a Rust <code>Vec</code>) that contains the <em>full paths</em> as strings of all non-hidden files, recursively.
<ul>
<li>Recursively means current directory and any sub-directories.</li>
</ul></li>
</ul>
</section>
<section id="cases" class="level2">
<h2 class="anchored" data-anchor-id="cases">Cases</h2>
<ul>
<li>I quickly check the file system for the presence of a hidden <code>.scm</code> file (or folder) which I use to save versions.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.isfile(SCM_NAME) <span class="kw">or</span> os.path.getsize(<span class="st">".scm"</span>) <span class="op">==</span> <span class="dv">0</span>:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>You’ll figure out in testing why you need this, and also why it is worthwhile to test if a file exists but is of size zero.
<ul>
<li>Any bad code between file opening and writing well-formed JSON will be very annoying.</li>
</ul></li>
<li>I’d expect a Rust <code>match</code> here, but you do you!</li>
</ul>
</section>
<section id="aside-.scm" class="level2">
<h2 class="anchored" data-anchor-id="aside-.scm">Aside: <code>.scm</code></h2>
<ul>
<li>Git’s hidden cache is called <code>.git</code></li>
<li>You don’t have to call your SCM <code>scm</code></li>
<li>I just had two globals I used so it was easy to change:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>SCM_NAME <span class="op">=</span> <span class="st">".scm"</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>DIFF_NAME <span class="op">=</span> <span class="st">".diff"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Obviously the code explodes if anything else uses those names, but <code>git</code> gets away with it, so…</li>
</ul>
</section>
<section id="initializing" class="level2">
<h2 class="anchored" data-anchor-id="initializing">Initializing</h2>
<ul>
<li>Initializing was straightforward.</li>
<li>Rip every file, I did into lists of lines (prints out better) and slam it into a Python dictionary (so a Rust <code>HashMap</code> or a <code>serde_json::Map</code>)</li>
<li>Then dump to the JSON formatted <code>.scm</code> file.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>latest <span class="op">=</span> {f: <span class="bu">open</span>(f).read().splitlines() <span class="cf">for</span> f <span class="kw">in</span> fs}</span>
<span id="cb6-2"><a href="#cb6-2"></a>json.dump(</span>
<span id="cb6-3"><a href="#cb6-3"></a>    {<span class="st">"latest"</span>: latest, <span class="st">"commit"</span>: [{<span class="st">"init"</span>: latest, <span class="st">"diff"</span>: {}}]},</span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="bu">open</span>(SCM_NAME, <span class="st">"w"</span>),</span>
<span id="cb6-5"><a href="#cb6-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subleties" class="level2">
<h2 class="anchored" data-anchor-id="subleties">Subleties</h2>
<ul>
<li>I do two things here that make more sense as you get further in the project:
<ul>
<li>I create a “latest” key, which stores the most recent <code>commit</code>ed version of all files.</li>
<li>I <em>separately</em> create a “commit” key, which stores a JSON array (so a Python list or Rust <code>Vec</code>)
<ul>
<li>This list contains itself an “init” key, for new files, and a “diff” key, for changed files.</li>
</ul></li>
</ul></li>
<li>Think about why you would want to get these things separate!</li>
</ul>
</section>
<section id="accessing-.scm" class="level2">
<h2 class="anchored" data-anchor-id="accessing-.scm">Accessing <code>.scm</code></h2>
<ul>
<li>Once some commit has been made, latter submits require appending to the JSON file.
<ul>
<li>Which of course I do by completely overwriting it, because that is easier.</li>
</ul></li>
<li>First I read it in a slice it up.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>scm <span class="op">=</span> json.loads(<span class="bu">open</span>(SCM_NAME, <span class="st">"r"</span>).read())</span>
<span id="cb7-2"><a href="#cb7-2"></a>late <span class="op">=</span> scm[<span class="st">"latest"</span>]</span>
<span id="cb7-3"><a href="#cb7-3"></a>curr <span class="op">=</span> scm[<span class="st">"commit"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Hard to understate how much nicer it is to allow yourself some niceties like caching the latest files.</li>
</ul>
</section>
<section id="checking-for-files" class="level2">
<h2 class="anchored" data-anchor-id="checking-for-files">Checking for files</h2>
<ul>
<li>At this point, I already determined <code>fs</code> - the current eligible files.</li>
<li>I also check:
<ul>
<li>What files are already under version control, and</li>
<li>Which ones aren’t.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>old_fs <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> curr[<span class="op">-</span><span class="dv">1</span>][<span class="st">"init"</span>]] <span class="op">+</span> [f <span class="cf">for</span> f <span class="kw">in</span> curr[<span class="op">-</span><span class="dv">1</span>][<span class="st">"diff"</span>]]</span>
<span id="cb8-2"><a href="#cb8-2"></a>new_fs <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> fs <span class="cf">if</span> fs <span class="kw">not</span> <span class="kw">in</span> old_fs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="aside-diff" class="level2">
<h2 class="anchored" data-anchor-id="aside-diff">Aside: Diff</h2>
<ul>
<li>The <code>diff</code> I like can’t be used gracefully from Python.
<ul>
<li>Either <code>diff</code> in a <code>subprocess.check_output</code>, or</li>
<li>Use <code>difflib</code> which makes unified diffs.</li>
</ul></li>
<li>I did this, which you will not and should not do - use your own Rust code from class.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>diff_lines <span class="op">=</span> <span class="kw">lambda</span> ls_0, ls_1: [line.rstrip() <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">list</span>(difflib.unified_diff(ls_0, ls_1))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>When you look at the <code>.scm</code> files in that repository, the diffs are <code>-u</code> diffs, and may appear “messy”</li>
</ul>
</section>
<section id="aside-n" class="level2">
<h2 class="anchored" data-anchor-id="aside-n">Aside: <code>\n</code></h2>
<ul>
<li>If you play around with <code>scm.py</code> it will explode if you don’t have an empty line at the end of your file.</li>
<li>The combination of <code>difflib</code> and <code>patch</code> can’t handle files that end without a trailing new line.</li>
<li>This is bad, and your SCM should not contain this bug (and I don’t think it will if you do all the steps properly).
<ul>
<li>(Do check)</li>
</ul></li>
</ul>
</section>
<section id="build-.scm" class="level2">
<h2 class="anchored" data-anchor-id="build-.scm">Build <code>.scm</code></h2>
<ul>
<li>Put all the <code>diff</code> in a JSON object / Python Dictionary / Rust <code>HashMap</code> / <code>serde_json::Map</code></li>
<li>Overwrite “latest”’s value with all the new versions.
<ul>
<li>We can get the old ones back since we have the diffs.</li>
</ul></li>
<li>Append a entry to “commit” containing an “init” and “diff”, either of which may be empty.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>diff <span class="op">=</span> {f: diff_lines(late[f], <span class="bu">open</span>(f).read().splitlines()) <span class="cf">for</span> f <span class="kw">in</span> old_fs}</span>
<span id="cb10-2"><a href="#cb10-2"></a>scm[<span class="st">"latest"</span>] <span class="op">=</span> {f: <span class="bu">open</span>(f).read().splitlines() <span class="cf">for</span> f <span class="kw">in</span> fs}</span>
<span id="cb10-3"><a href="#cb10-3"></a>scm[<span class="st">"commit"</span>].append({<span class="st">"init"</span>: init, <span class="st">"diff"</span>: diff})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="update-.scm" class="level2">
<h2 class="anchored" data-anchor-id="update-.scm">Update <code>.scm</code></h2>
<ul>
<li>Write to <code>.scm</code> using your preferred JSON library…
<ul>
<li>Or do some shenanigans with text files and a nested file system if you are Git-like.</li>
</ul></li>
<li>Manage all your files appropriately and gracefully exit.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>json.dump(scm, <span class="bu">open</span>(SCM_NAME, <span class="st">"w"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Oh and save your work - I did so using <code>git commit</code> - since you will explode your code all the time.</li>
</ul>
</section>
<section id="my-revert" class="level2">
<h2 class="anchored" data-anchor-id="my-revert">My Revert</h2>
<ul>
<li>My revert had a dependencies on a nicety, so I will do niceties than return to revert.</li>
</ul>
</section>
<section id="today-1" class="level2">
<h2 class="anchored" data-anchor-id="today-1">Today</h2>
<ul>
<li>Requirements
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>commit</code></label></li>
<li><label><input type="checkbox"><code>revert</code></label></li>
</ul></li>
<li>Nice-to-haves
<ul class="task-list">
<li><label><input type="checkbox"><code>viewer</code></label></li>
<li><label><input type="checkbox"><code>scrape</code></label></li>
</ul></li>
</ul>
</section>
</section>
<section id="niceties" class="level1">
<h1>Niceties</h1>
<section id="my-scrape" class="level2">
<h2 class="anchored" data-anchor-id="my-scrape">My scrape</h2>
<ul>
<li>When I write code, a lot of times I write bad code.
<ul>
<li>So I delete it.</li>
</ul></li>
<li>This is easier if you happen to working under control/management and can just type <code>./scm.py scrape</code> and get back the latest good version.
<ul>
<li>I think of it as “scraping off” my honk-honk-silly-goose era.</li>
</ul></li>
<li>If you aren’t doing it already, this could change your life!</li>
</ul>
</section>
<section id="dependency" class="level2">
<h2 class="anchored" data-anchor-id="dependency">Dependency</h2>
<ul>
<li>It also so happens that to successfully apply a diff, you need to do so against one of the two files that are, well, <code>diff</code>’ed.</li>
<li>The current file version isn’t necessarily one of those!</li>
<li>So keep track of a file version that that can receive a diff, so you can go back further than to the latest commit!</li>
</ul>
</section>
<section id="easy-mode" class="level2">
<h2 class="anchored" data-anchor-id="easy-mode">Easy-mode</h2>
<ul>
<li>I just open <code>.scm</code>, and unconditionally write everything in “latest” to the file system.</li>
<li>It’s a single (<code>black</code>-exploded) line.
<ul>
<li>I do add a gracefully exit if there’s been no commit yet.</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>(<span class="kw">not</span> os.path.isfile(SCM_NAME) <span class="kw">or</span> os.path.getsize(<span class="st">".scm"</span>) <span class="op">==</span> <span class="dv">0</span>) <span class="kw">and</span> exit()</span>
<span id="cb12-2"><a href="#cb12-2"></a>[</span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="bu">open</span>(k, <span class="st">"w"</span>).write(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(v))</span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> json.loads(<span class="bu">open</span>(SCM_NAME, <span class="st">"r"</span>).read())[<span class="st">"latest"</span>].items()</span>
<span id="cb12-5"><a href="#cb12-5"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="recall" class="level2">
<h2 class="anchored" data-anchor-id="recall">Recall</h2>
<ul>
<li>I’m not actually saving block text, I’m only saving lines.</li>
<li>So when I write to file, I rebuild the text blocks by combining lines with intermediate new-lines.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">"</span><span class="ch">\n</span><span class="co">"</span>.join(v) <span class="co"># v was "value" - the JSON array of strings (lines)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>This is mildly annoying but makes the JSON easier to read, so I did it.</li>
<li>I highlight this as an example of how you should make your own choices.</li>
</ul>
</section>
<section id="design-decision-1" class="level2">
<h2 class="anchored" data-anchor-id="design-decision-1">Design Decision</h2>
<ul>
<li>This would be quite difficult (as in your would be recursively applying diffs along the entirety of the <code>.scm</code> file) if you did not keep “latest” around.</li>
<li>Work smart not hard!</li>
</ul>
</section>
<section id="today-2" class="level2">
<h2 class="anchored" data-anchor-id="today-2">Today</h2>
<ul>
<li>Requirements
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>commit</code></label></li>
<li><label><input type="checkbox"><code>revert</code></label></li>
</ul></li>
<li>Nice-to-haves
<ul class="task-list">
<li><label><input type="checkbox"><code>viewer</code></label></li>
<li><label><input type="checkbox" checked=""><code>scrape</code></label></li>
</ul></li>
</ul>
</section>
</section>
<section id="requirements-1" class="level1">
<h1>Requirements</h1>
<section id="my-revert-1" class="level2">
<h2 class="anchored" data-anchor-id="my-revert-1">My Revert</h2>
<ul>
<li>Revert isn’t too bad once you have a scraper.
<ul>
<li>Scrape, then…</li>
<li>Look at the most recent commit, and</li>
<li>Look at all its diffs, then</li>
<li>Apply them all reverse style (<code>patch -R</code>)</li>
<li>Pop that commit off the JSON array and rewrite <code>.scm</code>
<ul>
<li>That is, destroy all traces.</li>
<li>(You can keep traces; I didn’t want to)</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="get-started" class="level2">
<h2 class="anchored" data-anchor-id="get-started">Get started</h2>
<ul>
<li>Scrape and open <code>.scm</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb14" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>scrape()</span>
<span id="cb14-2"><a href="#cb14-2"></a>scm <span class="op">=</span> json.loads(<span class="bu">open</span>(SCM_NAME, <span class="st">"r"</span>).read())</span>
<span id="cb14-3"><a href="#cb14-3"></a>late <span class="op">=</span> scm[<span class="st">"latest"</span>]</span>
<span id="cb14-4"><a href="#cb14-4"></a>curr <span class="op">=</span> scm[<span class="st">"commit"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="case-handling" class="level2">
<h2 class="anchored" data-anchor-id="case-handling">Case handling</h2>
<ul>
<li>By the way, you can’t revert if you only have one commit.
<ul>
<li>Think about why not!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="bu">len</span>(curr) <span class="op">&lt;</span> <span class="dv">2</span> <span class="kw">and</span> exit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>In general, make some effort to use your SCM as you write it to find this fun little corner cases.</li>
</ul>
</section>
<section id="pop-a-commit" class="level2">
<h2 class="anchored" data-anchor-id="pop-a-commit">Pop a commit</h2>
<ul>
<li>I didn’t destroy any new files.</li>
<li>Hard to care about that. Maybe I should?</li>
<li>So I just look at the “diff” values only, and destructive update the “commit” JSON array.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>last <span class="op">=</span> curr.pop()[<span class="st">"diff"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>This contains all we need to go back in time.</li>
</ul>
</section>
<section id="this-is-gross" class="level2">
<h2 class="anchored" data-anchor-id="this-is-gross">This is gross</h2>
<ul>
<li>I don’t think there’s a baseline Python <code>patch</code> so I had to hack a bit.</li>
<li>I throw the diff into the filesystem, use <code>os.system</code> to call <code>patch</code>, then clean up latter.</li>
<li>This is bad, don’t do this, write <code>patch</code> in Rust.
<ul>
<li>It is <em>very close</em> to diff!</li>
</ul></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> last.items():</span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="bu">open</span>(DIFF_NAME, <span class="st">"w"</span>).write(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(v))</span>
<span id="cb17-3"><a href="#cb17-3"></a>    os.system(<span class="st">"patch -R "</span> <span class="op">+</span> k <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> DIFF_NAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clean-up" class="level2">
<h2 class="anchored" data-anchor-id="clean-up">Clean up</h2>
<ul>
<li>Rewrite <code>.scm</code>, remove <code>.diff</code>, and exit gracefully.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>json.dump(scm, <span class="bu">open</span>(SCM_NAME, <span class="st">"w"</span>))</span>
<span id="cb18-2"><a href="#cb18-2"></a>os.delete(DIFF_NAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="understanding-check" class="level2">
<h2 class="anchored" data-anchor-id="understanding-check">Understanding check</h2>
<ul>
<li>My revert is wrong and puts the SCM into an unstable state.</li>
<li>How?</li>
</ul>
</section>
<section id="answer" class="level2">
<h2 class="anchored" data-anchor-id="answer">Answer</h2>
<ul>
<li>I don’t rewrite “latest” after a revert!
<ul>
<li>I forgot this and didn’t uncover it in testing!</li>
<li>Test your code!</li>
<li>I just noticed when writing these slides!</li>
</ul></li>
<li><a href="https://github.com/cd-c89/scmpy/issues/1">Read me</a></li>
</ul>
</section>
<section id="hint" class="level2">
<h2 class="anchored" data-anchor-id="hint">Hint</h2>
<ul>
<li>The code to fix this already exists in <code>scm.py</code></li>
<li>It should be factored!</li>
</ul>
</section>
<section id="today-3" class="level2">
<h2 class="anchored" data-anchor-id="today-3">Today</h2>
<ul>
<li>Requirements
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>commit</code></label></li>
<li><label><input type="checkbox" checked=""><code>revert</code></label></li>
</ul></li>
<li>Nice-to-haves
<ul class="task-list">
<li><label><input type="checkbox"><code>viewer</code></label></li>
<li><label><input type="checkbox" checked=""><code>scrape</code></label></li>
</ul></li>
</ul>
</section>
</section>
<section id="niceties-1" class="level1">
<h1>Niceties</h1>
<section id="my-viewer" class="level2">
<h2 class="anchored" data-anchor-id="my-viewer">My Viewer</h2>
<ul>
<li>I don’t think pretty-print is interesting, but…</li>
<li>We did play around with it a bit on Wordle, and it can be fun.</li>
<li>Engage at your own discretion.</li>
<li>Just got tired of using <code>python3 -m json-tool</code> and it was ugly so I played around a bit.</li>
</ul>
</section>
<section id="i-just-use-jq" class="level2">
<h2 class="anchored" data-anchor-id="i-just-use-jq">I just use <code>jq</code></h2>
<ul>
<li>I hear just about every system has <code>jq</code> on it.</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>scm.py</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="scm.py"><pre class="sourceCode numberSource py number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>viewer <span class="op">=</span> <span class="kw">lambda</span>: os.system(</span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="st">"jq . .scm"</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>)  <span class="co"># print(json.dumps(json.load(open(SCM_NAME)), indent=4))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>And if not I just used <code>json</code>, so</li>
<li>Anyways, if you don’t use JSON, you have to write something yourself.
<ul>
<li>It must show what a previous version would look like, some how.</li>
</ul></li>
</ul>
</section>
<section id="git-show---stat" class="level2">
<h2 class="anchored" data-anchor-id="git-show---stat"><code>git show --stat</code></h2>
<ul>
<li>I don’t love this.
<ul>
<li>Can’t tell <em>what</em> the changes are, but…</li>
<li>It is good enough if you don’t go the JSON route.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">$</span> git show <span class="at">--stat</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="ex">commit</span> 9b1cd0fc410b50a25370b5bcaa57ceb407e51bff <span class="er">(</span><span class="ex">HEAD</span> <span class="at">-</span><span class="op">&gt;</span> main, origin/main, origin/HEAD<span class="kw">)</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="ex">Author:</span> c <span class="op">&lt;</span>ckdeutschbein@willamette.edu<span class="op">&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="ex">Date:</span>   Sat Nov 29 12:44:40 2025 <span class="at">-0800</span></span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a>    <span class="ex">think</span> this is good enough</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a> <span class="ex">.scm</span>   <span class="kw">|</span> <span class="ex">2</span> +-</span>
<span id="cb20-9"><a href="#cb20-9"></a> <span class="ex">scm.py</span> <span class="kw">|</span> <span class="ex">8</span> ++++----</span>
<span id="cb20-10"><a href="#cb20-10"></a> <span class="ex">2</span> files changed, 5 insertions<span class="er">(</span><span class="ex">+</span><span class="kw">)</span><span class="ex">,</span> 5 deletions<span class="er">(</span><span class="ex">-</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="minimal" class="level2">
<h2 class="anchored" data-anchor-id="minimal">Minimal</h2>
<ul>
<li>First 3 lines are of course hash stuff, and now optional.</li>
<li>Next line is a commit message, which I didn’t require (or even support, though it would be trivial to do so)</li>
<li>This would be fine for the final.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="ex">$</span> ./scm viewer <span class="co"># assuming you name your binary `scm`</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="ex">.scm</span>   <span class="kw">|</span> <span class="ex">2</span> +-</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="ex">scm.py</span> <span class="kw">|</span> <span class="ex">8</span> ++++----</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="today-4" class="level2">
<h2 class="anchored" data-anchor-id="today-4">Today</h2>
<ul>
<li>Requirements
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>commit</code></label></li>
<li><label><input type="checkbox" checked=""><code>revert</code></label></li>
</ul></li>
<li>Nice-to-haves
<ul class="task-list">
<li><label><input type="checkbox" checked=""><code>viewer</code></label></li>
<li><label><input type="checkbox" checked=""><code>scrape</code></label></li>
</ul></li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./D0_serde.html" class="pagination-link" aria-label="Serde">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Serde</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb22" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1"></a><span class="co">---</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="an">title:</span><span class="co"> SCM</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co">---</span></span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="fu"># Announcements</span></span>
<span id="cb22-6"><a href="#cb22-6"></a></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="ss">- </span>Source Control Management</span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="ss">  - </span>LCS / <span class="in">`diff`</span> ongoing</span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="ss">  - </span>Hash Trees covered, not yet deployed</span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="ss">  - </span>A Pythonic (ew!) <span class="co">[</span><span class="ot">reference solution</span><span class="co">](https://github.com/cd-c89/scmpy/tree/main)</span>.</span>
<span id="cb22-11"><a href="#cb22-11"></a>    </span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="fu">## Today</span></span>
<span id="cb22-13"><a href="#cb22-13"></a></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="ss">- </span>Requirements</span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`commit`</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`revert`</span></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="ss">- </span>Nice-to-haves</span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`viewer`</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`scrape`</span></span>
<span id="cb22-20"><a href="#cb22-20"></a></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="fu">## Never    </span></span>
<span id="cb22-22"><a href="#cb22-22"></a></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="ss">- </span>Extensions</span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="ss">    - </span>Hashing</span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="ss">    - </span>Signatures</span>
<span id="cb22-26"><a href="#cb22-26"></a><span class="ss">    - </span>Branches</span>
<span id="cb22-27"><a href="#cb22-27"></a></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="fu">## Git Example</span></span>
<span id="cb22-29"><a href="#cb22-29"></a>    </span>
<span id="cb22-30"><a href="#cb22-30"></a><span class="in">```{.sh}</span></span>
<span id="cb22-31"><a href="#cb22-31"></a><span class="in">$ tree .git</span></span>
<span id="cb22-32"><a href="#cb22-32"></a><span class="in">.git</span></span>
<span id="cb22-33"><a href="#cb22-33"></a><span class="in">├── COMMIT_EDITMSG</span></span>
<span id="cb22-34"><a href="#cb22-34"></a><span class="in">├── HEAD</span></span>
<span id="cb22-35"><a href="#cb22-35"></a><span class="in">├── branches</span></span>
<span id="cb22-36"><a href="#cb22-36"></a><span class="in">├── config</span></span>
<span id="cb22-37"><a href="#cb22-37"></a><span class="in">├── description</span></span>
<span id="cb22-38"><a href="#cb22-38"></a><span class="in">├── hooks</span></span>
<span id="cb22-39"><a href="#cb22-39"></a><span class="in">│&nbsp;&nbsp; ├── applypatch-msg.sample</span></span>
<span id="cb22-40"><a href="#cb22-40"></a><span class="in">│&nbsp;&nbsp; ├── commit-msg.sample</span></span>
<span id="cb22-41"><a href="#cb22-41"></a><span class="in">│&nbsp;&nbsp; ├── fsmonitor-watchman.sample</span></span>
<span id="cb22-42"><a href="#cb22-42"></a><span class="in">│&nbsp;&nbsp; ├── post-update.sample</span></span>
<span id="cb22-43"><a href="#cb22-43"></a><span class="in">│&nbsp;&nbsp; ├── pre-applypatch.sample</span></span>
<span id="cb22-44"><a href="#cb22-44"></a><span class="in">│&nbsp;&nbsp; ├── pre-commit.sample</span></span>
<span id="cb22-45"><a href="#cb22-45"></a><span class="in">│&nbsp;&nbsp; ├── pre-merge-commit.sample</span></span>
<span id="cb22-46"><a href="#cb22-46"></a><span class="in">│&nbsp;&nbsp; ├── pre-push.sample</span></span>
<span id="cb22-47"><a href="#cb22-47"></a><span class="in">│&nbsp;&nbsp; ├── pre-rebase.sample</span></span>
<span id="cb22-48"><a href="#cb22-48"></a><span class="in">│&nbsp;&nbsp; ├── pre-receive.sample</span></span>
<span id="cb22-49"><a href="#cb22-49"></a><span class="in">│&nbsp;&nbsp; ├── prepare-commit-msg.sample</span></span>
<span id="cb22-50"><a href="#cb22-50"></a><span class="in">│&nbsp;&nbsp; ├── push-to-checkout.sample</span></span>
<span id="cb22-51"><a href="#cb22-51"></a><span class="in">│&nbsp;&nbsp; └── update.sample</span></span>
<span id="cb22-52"><a href="#cb22-52"></a><span class="in">├── index</span></span>
<span id="cb22-53"><a href="#cb22-53"></a><span class="in">├── info</span></span>
<span id="cb22-54"><a href="#cb22-54"></a><span class="in">│&nbsp;&nbsp; └── exclude</span></span>
<span id="cb22-55"><a href="#cb22-55"></a><span class="in">├── logs</span></span>
<span id="cb22-56"><a href="#cb22-56"></a><span class="in">│&nbsp;&nbsp; ├── HEAD</span></span>
<span id="cb22-57"><a href="#cb22-57"></a><span class="in">│&nbsp;&nbsp; └── refs</span></span>
<span id="cb22-58"><a href="#cb22-58"></a><span class="in">│&nbsp;&nbsp;     ├── heads</span></span>
<span id="cb22-59"><a href="#cb22-59"></a><span class="in">│&nbsp;&nbsp;     │&nbsp;&nbsp; └── main</span></span>
<span id="cb22-60"><a href="#cb22-60"></a><span class="in">│&nbsp;&nbsp;     └── remotes</span></span>
<span id="cb22-61"><a href="#cb22-61"></a><span class="in">│&nbsp;&nbsp;         └── origin</span></span>
<span id="cb22-62"><a href="#cb22-62"></a><span class="in">│&nbsp;&nbsp;             ├── HEAD</span></span>
<span id="cb22-63"><a href="#cb22-63"></a><span class="in">│&nbsp;&nbsp;             └── main</span></span>
<span id="cb22-64"><a href="#cb22-64"></a><span class="in">├── objects</span></span>
<span id="cb22-65"><a href="#cb22-65"></a><span class="in">│&nbsp;&nbsp; ├── 14</span></span>
<span id="cb22-66"><a href="#cb22-66"></a><span class="in">│&nbsp;&nbsp; │&nbsp;&nbsp; └── 699a133ae84e6c922ca69ffa74d4df47eae49f</span></span>
<span id="cb22-67"><a href="#cb22-67"></a><span class="in">│&nbsp;&nbsp; ├── 4b</span></span>
<span id="cb22-68"><a href="#cb22-68"></a><span class="in">│&nbsp;&nbsp; │&nbsp;&nbsp; └── 41ec9ea0317e27beac7c2d77945e542c26f943</span></span>
<span id="cb22-69"><a href="#cb22-69"></a><span class="in">│&nbsp;&nbsp; ├── a3</span></span>
<span id="cb22-70"><a href="#cb22-70"></a><span class="in">│&nbsp;&nbsp; │&nbsp;&nbsp; └── 1c05f02ab1855a2f7e420ee0f5b28c2d8c1008</span></span>
<span id="cb22-71"><a href="#cb22-71"></a><span class="in">│&nbsp;&nbsp; ├── b9</span></span>
<span id="cb22-72"><a href="#cb22-72"></a><span class="in">│&nbsp;&nbsp; │&nbsp;&nbsp; └── 1bf6a71c95a125d9e0cd59e1149ad022b8baeb</span></span>
<span id="cb22-73"><a href="#cb22-73"></a><span class="in">│&nbsp;&nbsp; ├── info</span></span>
<span id="cb22-74"><a href="#cb22-74"></a><span class="in">│&nbsp;&nbsp; └── pack</span></span>
<span id="cb22-75"><a href="#cb22-75"></a><span class="in">│&nbsp;&nbsp;     ├── pack-6fbf46b3e979d9d021e11db53f6959e1178cbd97.idx</span></span>
<span id="cb22-76"><a href="#cb22-76"></a><span class="in">│&nbsp;&nbsp;     └── pack-6fbf46b3e979d9d021e11db53f6959e1178cbd97.pack</span></span>
<span id="cb22-77"><a href="#cb22-77"></a><span class="in">├── packed-refs</span></span>
<span id="cb22-78"><a href="#cb22-78"></a><span class="in">└── refs</span></span>
<span id="cb22-79"><a href="#cb22-79"></a><span class="in">    ├── heads</span></span>
<span id="cb22-80"><a href="#cb22-80"></a><span class="in">    │&nbsp;&nbsp; └── main</span></span>
<span id="cb22-81"><a href="#cb22-81"></a><span class="in">    ├── remotes</span></span>
<span id="cb22-82"><a href="#cb22-82"></a><span class="in">    │&nbsp;&nbsp; └── origin</span></span>
<span id="cb22-83"><a href="#cb22-83"></a><span class="in">    │&nbsp;&nbsp;     ├── HEAD</span></span>
<span id="cb22-84"><a href="#cb22-84"></a><span class="in">    │&nbsp;&nbsp;     └── main</span></span>
<span id="cb22-85"><a href="#cb22-85"></a><span class="in">    └── tags</span></span>
<span id="cb22-86"><a href="#cb22-86"></a></span>
<span id="cb22-87"><a href="#cb22-87"></a><span class="in">20 directories, 33 files</span></span>
<span id="cb22-88"><a href="#cb22-88"></a><span class="in">```</span></span>
<span id="cb22-89"><a href="#cb22-89"></a></span>
<span id="cb22-90"><a href="#cb22-90"></a><span class="ss">- </span>"Everything is a file" - Linux</span>
<span id="cb22-91"><a href="#cb22-91"></a></span>
<span id="cb22-92"><a href="#cb22-92"></a><span class="fu">## Counter proposal</span></span>
<span id="cb22-93"><a href="#cb22-93"></a></span>
<span id="cb22-94"><a href="#cb22-94"></a><span class="ss">- </span>Via <span class="in">`./scm.py viewer`</span></span>
<span id="cb22-95"><a href="#cb22-95"></a></span>
<span id="cb22-96"><a href="#cb22-96"></a><span class="in">```{.json}</span></span>
<span id="cb22-97"><a href="#cb22-97"></a><span class="in">{</span></span>
<span id="cb22-98"><a href="#cb22-98"></a><span class="in">  "latest": {</span></span>
<span id="cb22-99"><a href="#cb22-99"></a><span class="in">    "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-100"><a href="#cb22-100"></a><span class="in">      "#!/usr/bin/env python3",</span></span>
<span id="cb22-101"><a href="#cb22-101"></a><span class="in">      "",</span></span>
<span id="cb22-102"><a href="#cb22-102"></a><span class="in">      "import os, sys, json, subprocess, difflib",</span></span>
<span id="cb22-103"><a href="#cb22-103"></a><span class="in">      "",</span></span>
<span id="cb22-104"><a href="#cb22-104"></a><span class="in">      "SCM_NAME = \".scm\"",</span></span>
<span id="cb22-105"><a href="#cb22-105"></a><span class="in">      "DIFF_NAME = \".diff\"",</span></span>
<span id="cb22-106"><a href="#cb22-106"></a><span class="in">      "",</span></span>
<span id="cb22-107"><a href="#cb22-107"></a><span class="in">      "# diff helper",</span></span>
<span id="cb22-108"><a href="#cb22-108"></a><span class="in">      "diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-109"><a href="#cb22-109"></a><span class="in">      "",</span></span>
<span id="cb22-110"><a href="#cb22-110"></a><span class="in">      "# saves current version to .scm",</span></span>
<span id="cb22-111"><a href="#cb22-111"></a><span class="in">      "def commit():",</span></span>
<span id="cb22-112"><a href="#cb22-112"></a><span class="in">      "    # Get all files that aren't hidden",</span></span>
<span id="cb22-113"><a href="#cb22-113"></a><span class="in">      "    tree = [node for node in os.walk(os.getcwd()) if \".\" not in node[0]]",</span></span>
<span id="cb22-114"><a href="#cb22-114"></a><span class="in">      "    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != \".\"]",</span></span>
<span id="cb22-115"><a href="#cb22-115"></a><span class="in">      "",</span></span>
<span id="cb22-116"><a href="#cb22-116"></a><span class="in">      "    # Get or create .scm file",</span></span>
<span id="cb22-117"><a href="#cb22-117"></a><span class="in">      "    if not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0:",</span></span>
<span id="cb22-118"><a href="#cb22-118"></a><span class="in">      "        # create",</span></span>
<span id="cb22-119"><a href="#cb22-119"></a><span class="in">      "        latest = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-120"><a href="#cb22-120"></a><span class="in">      "        json.dump(",</span></span>
<span id="cb22-121"><a href="#cb22-121"></a><span class="in">      "            {\"latest\": latest, \"commit\": [{\"init\": latest, \"diff\": {}}]},",</span></span>
<span id="cb22-122"><a href="#cb22-122"></a><span class="in">      "            open(SCM_NAME, \"w\"),",</span></span>
<span id="cb22-123"><a href="#cb22-123"></a><span class="in">      "        )",</span></span>
<span id="cb22-124"><a href="#cb22-124"></a><span class="in">      "    else:",</span></span>
<span id="cb22-125"><a href="#cb22-125"></a><span class="in">      "        # get",</span></span>
<span id="cb22-126"><a href="#cb22-126"></a><span class="in">      "        scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-127"><a href="#cb22-127"></a><span class="in">      "        late = scm[\"latest\"]",</span></span>
<span id="cb22-128"><a href="#cb22-128"></a><span class="in">      "        curr = scm[\"commit\"]",</span></span>
<span id="cb22-129"><a href="#cb22-129"></a><span class="in">      "        old_fs = [f for f in curr[-1][\"init\"]] + [f for f in curr[-1][\"diff\"]]",</span></span>
<span id="cb22-130"><a href="#cb22-130"></a><span class="in">      "        new_fs = [f for f in fs if fs not in old_fs]",</span></span>
<span id="cb22-131"><a href="#cb22-131"></a><span class="in">      "        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}",</span></span>
<span id="cb22-132"><a href="#cb22-132"></a><span class="in">      "        # We use unified diff from difflib since it still works with patch.",</span></span>
<span id="cb22-133"><a href="#cb22-133"></a><span class="in">      "        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}",</span></span>
<span id="cb22-134"><a href="#cb22-134"></a><span class="in">      "        scm[\"latest\"] = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-135"><a href="#cb22-135"></a><span class="in">      "        scm[\"commit\"].append({\"init\": init, \"diff\": diff})",</span></span>
<span id="cb22-136"><a href="#cb22-136"></a><span class="in">      "        json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-137"><a href="#cb22-137"></a><span class="in">      "",</span></span>
<span id="cb22-138"><a href="#cb22-138"></a><span class="in">      "",</span></span>
<span id="cb22-139"><a href="#cb22-139"></a><span class="in">      "# pops latest without caching.",</span></span>
<span id="cb22-140"><a href="#cb22-140"></a><span class="in">      "# not gonna ether novel files, that seems pointless?",</span></span>
<span id="cb22-141"><a href="#cb22-141"></a><span class="in">      "def scrape():",</span></span>
<span id="cb22-142"><a href="#cb22-142"></a><span class="in">      "    (not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0) and exit()",</span></span>
<span id="cb22-143"><a href="#cb22-143"></a><span class="in">      "    [",</span></span>
<span id="cb22-144"><a href="#cb22-144"></a><span class="in">      "        open(k, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-145"><a href="#cb22-145"></a><span class="in">      "        for k, v in json.loads(open(SCM_NAME, \"r\").read())[\"latest\"].items()",</span></span>
<span id="cb22-146"><a href="#cb22-146"></a><span class="in">      "    ]",</span></span>
<span id="cb22-147"><a href="#cb22-147"></a><span class="in">      "",</span></span>
<span id="cb22-148"><a href="#cb22-148"></a><span class="in">      "",</span></span>
<span id="cb22-149"><a href="#cb22-149"></a><span class="in">      "# let's just roll back one, that's logically equivalent",</span></span>
<span id="cb22-150"><a href="#cb22-150"></a><span class="in">      "def revert():",</span></span>
<span id="cb22-151"><a href="#cb22-151"></a><span class="in">      "    scrape()",</span></span>
<span id="cb22-152"><a href="#cb22-152"></a><span class="in">      "    scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-153"><a href="#cb22-153"></a><span class="in">      "    late = scm[\"latest\"]",</span></span>
<span id="cb22-154"><a href="#cb22-154"></a><span class="in">      "    curr = scm[\"commit\"]",</span></span>
<span id="cb22-155"><a href="#cb22-155"></a><span class="in">      "    len(curr) &lt; 2 and exit()",</span></span>
<span id="cb22-156"><a href="#cb22-156"></a><span class="in">      "    last = curr.pop()[\"diff\"]",</span></span>
<span id="cb22-157"><a href="#cb22-157"></a><span class="in">      "    for k, v in last.items():",</span></span>
<span id="cb22-158"><a href="#cb22-158"></a><span class="in">      "        open(DIFF_NAME, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-159"><a href="#cb22-159"></a><span class="in">      "        os.system(\"patch -R \" + k + \" \" + DIFF_NAME)",</span></span>
<span id="cb22-160"><a href="#cb22-160"></a><span class="in">      "    json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-161"><a href="#cb22-161"></a><span class="in">      "",</span></span>
<span id="cb22-162"><a href="#cb22-162"></a><span class="in">      "viewer = lambda: os.system(",</span></span>
<span id="cb22-163"><a href="#cb22-163"></a><span class="in">      "    \"jq . .scm\"",</span></span>
<span id="cb22-164"><a href="#cb22-164"></a><span class="in">      ")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))",</span></span>
<span id="cb22-165"><a href="#cb22-165"></a><span class="in">      "",</span></span>
<span id="cb22-166"><a href="#cb22-166"></a><span class="in">      "# Trivial Comment",</span></span>
<span id="cb22-167"><a href="#cb22-167"></a><span class="in">      "",</span></span>
<span id="cb22-168"><a href="#cb22-168"></a><span class="in">      "# Another",</span></span>
<span id="cb22-169"><a href="#cb22-169"></a><span class="in">      "",</span></span>
<span id="cb22-170"><a href="#cb22-170"></a><span class="in">      "__name__ == \"__main__\" and len(sys.argv) == 2 and {",</span></span>
<span id="cb22-171"><a href="#cb22-171"></a><span class="in">      "    \"commit\": commit,",</span></span>
<span id="cb22-172"><a href="#cb22-172"></a><span class="in">      "    \"scrape\": scrape,",</span></span>
<span id="cb22-173"><a href="#cb22-173"></a><span class="in">      "    \"revert\": revert,",</span></span>
<span id="cb22-174"><a href="#cb22-174"></a><span class="in">      "    \"viewer\": viewer,",</span></span>
<span id="cb22-175"><a href="#cb22-175"></a><span class="in">      "}[sys.argv[1]]()",</span></span>
<span id="cb22-176"><a href="#cb22-176"></a><span class="in">      ""</span></span>
<span id="cb22-177"><a href="#cb22-177"></a><span class="in">    ],</span></span>
<span id="cb22-178"><a href="#cb22-178"></a><span class="in">    "/home/user/tmp/scmpy/scm.py.orig": [</span></span>
<span id="cb22-179"><a href="#cb22-179"></a><span class="in">      "#!/usr/bin/env python3",</span></span>
<span id="cb22-180"><a href="#cb22-180"></a><span class="in">      "",</span></span>
<span id="cb22-181"><a href="#cb22-181"></a><span class="in">      "import os, sys, json, subprocess, difflib",</span></span>
<span id="cb22-182"><a href="#cb22-182"></a><span class="in">      "",</span></span>
<span id="cb22-183"><a href="#cb22-183"></a><span class="in">      "SCM_NAME = \".scm\"",</span></span>
<span id="cb22-184"><a href="#cb22-184"></a><span class="in">      "DIFF_NAME = \".diff\"",</span></span>
<span id="cb22-185"><a href="#cb22-185"></a><span class="in">      "",</span></span>
<span id="cb22-186"><a href="#cb22-186"></a><span class="in">      "# diff helper",</span></span>
<span id="cb22-187"><a href="#cb22-187"></a><span class="in">      "diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-188"><a href="#cb22-188"></a><span class="in">      "",</span></span>
<span id="cb22-189"><a href="#cb22-189"></a><span class="in">      "# saves current version to .scm",</span></span>
<span id="cb22-190"><a href="#cb22-190"></a><span class="in">      "def commit():",</span></span>
<span id="cb22-191"><a href="#cb22-191"></a><span class="in">      "    # Get all files that aren't hidden",</span></span>
<span id="cb22-192"><a href="#cb22-192"></a><span class="in">      "    tree = [node for node in os.walk(os.getcwd()) if \".\" not in node[0]]",</span></span>
<span id="cb22-193"><a href="#cb22-193"></a><span class="in">      "    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != \".\"]",</span></span>
<span id="cb22-194"><a href="#cb22-194"></a><span class="in">      "",</span></span>
<span id="cb22-195"><a href="#cb22-195"></a><span class="in">      "    # Get or create .scm file",</span></span>
<span id="cb22-196"><a href="#cb22-196"></a><span class="in">      "    if not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0:",</span></span>
<span id="cb22-197"><a href="#cb22-197"></a><span class="in">      "        # create",</span></span>
<span id="cb22-198"><a href="#cb22-198"></a><span class="in">      "        latest = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-199"><a href="#cb22-199"></a><span class="in">      "        json.dump(",</span></span>
<span id="cb22-200"><a href="#cb22-200"></a><span class="in">      "            {\"latest\": latest, \"commit\": [{\"init\": latest, \"diff\": {}}]},",</span></span>
<span id="cb22-201"><a href="#cb22-201"></a><span class="in">      "            open(SCM_NAME, \"w\"),",</span></span>
<span id="cb22-202"><a href="#cb22-202"></a><span class="in">      "        )",</span></span>
<span id="cb22-203"><a href="#cb22-203"></a><span class="in">      "    else:",</span></span>
<span id="cb22-204"><a href="#cb22-204"></a><span class="in">      "        # get",</span></span>
<span id="cb22-205"><a href="#cb22-205"></a><span class="in">      "        scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-206"><a href="#cb22-206"></a><span class="in">      "        late = scm[\"latest\"]",</span></span>
<span id="cb22-207"><a href="#cb22-207"></a><span class="in">      "        curr = scm[\"commit\"]",</span></span>
<span id="cb22-208"><a href="#cb22-208"></a><span class="in">      "        old_fs = [f for f in curr[-1][\"init\"]] + [f for f in curr[-1][\"diff\"]]",</span></span>
<span id="cb22-209"><a href="#cb22-209"></a><span class="in">      "        new_fs = [f for f in fs if fs not in old_fs]",</span></span>
<span id="cb22-210"><a href="#cb22-210"></a><span class="in">      "        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}",</span></span>
<span id="cb22-211"><a href="#cb22-211"></a><span class="in">      "        # We use unified diff from difflib since it still works with patch.",</span></span>
<span id="cb22-212"><a href="#cb22-212"></a><span class="in">      "        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}",</span></span>
<span id="cb22-213"><a href="#cb22-213"></a><span class="in">      "        scm[\"latest\"] = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-214"><a href="#cb22-214"></a><span class="in">      "        scm[\"commit\"].append({\"init\": init, \"diff\": diff})",</span></span>
<span id="cb22-215"><a href="#cb22-215"></a><span class="in">      "        json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-216"><a href="#cb22-216"></a><span class="in">      "",</span></span>
<span id="cb22-217"><a href="#cb22-217"></a><span class="in">      "",</span></span>
<span id="cb22-218"><a href="#cb22-218"></a><span class="in">      "# pops latest without caching.",</span></span>
<span id="cb22-219"><a href="#cb22-219"></a><span class="in">      "# not gonna ether novel files, that seems pointless?",</span></span>
<span id="cb22-220"><a href="#cb22-220"></a><span class="in">      "def scrape():",</span></span>
<span id="cb22-221"><a href="#cb22-221"></a><span class="in">      "    (not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0) and exit()",</span></span>
<span id="cb22-222"><a href="#cb22-222"></a><span class="in">      "    [",</span></span>
<span id="cb22-223"><a href="#cb22-223"></a><span class="in">      "        open(k, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-224"><a href="#cb22-224"></a><span class="in">      "        for k, v in json.loads(open(SCM_NAME, \"r\").read())[\"latest\"].items()",</span></span>
<span id="cb22-225"><a href="#cb22-225"></a><span class="in">      "    ]",</span></span>
<span id="cb22-226"><a href="#cb22-226"></a><span class="in">      "",</span></span>
<span id="cb22-227"><a href="#cb22-227"></a><span class="in">      "",</span></span>
<span id="cb22-228"><a href="#cb22-228"></a><span class="in">      "# let's just roll back one, that's logically equivalent",</span></span>
<span id="cb22-229"><a href="#cb22-229"></a><span class="in">      "def revert():",</span></span>
<span id="cb22-230"><a href="#cb22-230"></a><span class="in">      "    scrape()",</span></span>
<span id="cb22-231"><a href="#cb22-231"></a><span class="in">      "    scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-232"><a href="#cb22-232"></a><span class="in">      "    late = scm[\"latest\"]",</span></span>
<span id="cb22-233"><a href="#cb22-233"></a><span class="in">      "    curr = scm[\"commit\"]",</span></span>
<span id="cb22-234"><a href="#cb22-234"></a><span class="in">      "    len(curr) &lt; 2 and exit()",</span></span>
<span id="cb22-235"><a href="#cb22-235"></a><span class="in">      "    last = curr.pop()[\"diff\"]",</span></span>
<span id="cb22-236"><a href="#cb22-236"></a><span class="in">      "    for k, v in last.items():",</span></span>
<span id="cb22-237"><a href="#cb22-237"></a><span class="in">      "        open(DIFF_NAME, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-238"><a href="#cb22-238"></a><span class="in">      "        os.system(\"patch -R \" + k + \" \" + DIFF_NAME)",</span></span>
<span id="cb22-239"><a href="#cb22-239"></a><span class="in">      "",</span></span>
<span id="cb22-240"><a href="#cb22-240"></a><span class="in">      "",</span></span>
<span id="cb22-241"><a href="#cb22-241"></a><span class="in">      "viewer = lambda: os.system(",</span></span>
<span id="cb22-242"><a href="#cb22-242"></a><span class="in">      "    \"jq . .scm\"",</span></span>
<span id="cb22-243"><a href="#cb22-243"></a><span class="in">      ")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))",</span></span>
<span id="cb22-244"><a href="#cb22-244"></a><span class="in">      "",</span></span>
<span id="cb22-245"><a href="#cb22-245"></a><span class="in">      "__name__ == \"__main__\" and len(sys.argv) == 2 and {",</span></span>
<span id="cb22-246"><a href="#cb22-246"></a><span class="in">      "    \"commit\": commit,",</span></span>
<span id="cb22-247"><a href="#cb22-247"></a><span class="in">      "    \"scrape\": scrape,",</span></span>
<span id="cb22-248"><a href="#cb22-248"></a><span class="in">      "    \"revert\": revert,",</span></span>
<span id="cb22-249"><a href="#cb22-249"></a><span class="in">      "    \"viewer\": viewer,",</span></span>
<span id="cb22-250"><a href="#cb22-250"></a><span class="in">      "}[sys.argv[1]]()",</span></span>
<span id="cb22-251"><a href="#cb22-251"></a><span class="in">      ""</span></span>
<span id="cb22-252"><a href="#cb22-252"></a><span class="in">    ]</span></span>
<span id="cb22-253"><a href="#cb22-253"></a><span class="in">  },</span></span>
<span id="cb22-254"><a href="#cb22-254"></a><span class="in">  "commit": [</span></span>
<span id="cb22-255"><a href="#cb22-255"></a><span class="in">    {</span></span>
<span id="cb22-256"><a href="#cb22-256"></a><span class="in">      "init": {</span></span>
<span id="cb22-257"><a href="#cb22-257"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-258"><a href="#cb22-258"></a><span class="in">          "#!/usr/bin/env python3",</span></span>
<span id="cb22-259"><a href="#cb22-259"></a><span class="in">          "",</span></span>
<span id="cb22-260"><a href="#cb22-260"></a><span class="in">          "import os, sys, json, subprocess, difflib",</span></span>
<span id="cb22-261"><a href="#cb22-261"></a><span class="in">          "",</span></span>
<span id="cb22-262"><a href="#cb22-262"></a><span class="in">          "SCM_NAME = \".scm\"",</span></span>
<span id="cb22-263"><a href="#cb22-263"></a><span class="in">          "DIFF_NAME = \".diff\"",</span></span>
<span id="cb22-264"><a href="#cb22-264"></a><span class="in">          "",</span></span>
<span id="cb22-265"><a href="#cb22-265"></a><span class="in">          "# diff helper",</span></span>
<span id="cb22-266"><a href="#cb22-266"></a><span class="in">          "diff_lines = lambda ls_0, ls_1: [line.strip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-267"><a href="#cb22-267"></a><span class="in">          "",</span></span>
<span id="cb22-268"><a href="#cb22-268"></a><span class="in">          "# saves current version to .scm",</span></span>
<span id="cb22-269"><a href="#cb22-269"></a><span class="in">          "def commit():",</span></span>
<span id="cb22-270"><a href="#cb22-270"></a><span class="in">          "    # Get all files that aren't hidden",</span></span>
<span id="cb22-271"><a href="#cb22-271"></a><span class="in">          "    tree = [node for node in os.walk(os.getcwd()) if \".\" not in node[0]]",</span></span>
<span id="cb22-272"><a href="#cb22-272"></a><span class="in">          "    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != \".\"]",</span></span>
<span id="cb22-273"><a href="#cb22-273"></a><span class="in">          "",</span></span>
<span id="cb22-274"><a href="#cb22-274"></a><span class="in">          "    # Get or create .scm file",</span></span>
<span id="cb22-275"><a href="#cb22-275"></a><span class="in">          "    if not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0:",</span></span>
<span id="cb22-276"><a href="#cb22-276"></a><span class="in">          "        # create",</span></span>
<span id="cb22-277"><a href="#cb22-277"></a><span class="in">          "        latest = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-278"><a href="#cb22-278"></a><span class="in">          "        json.dump(",</span></span>
<span id="cb22-279"><a href="#cb22-279"></a><span class="in">          "            {\"latest\": latest, \"commit\": [{\"init\": latest, \"diff\": {}}]},",</span></span>
<span id="cb22-280"><a href="#cb22-280"></a><span class="in">          "            open(SCM_NAME, \"w\"),",</span></span>
<span id="cb22-281"><a href="#cb22-281"></a><span class="in">          "        )",</span></span>
<span id="cb22-282"><a href="#cb22-282"></a><span class="in">          "    else:",</span></span>
<span id="cb22-283"><a href="#cb22-283"></a><span class="in">          "        # get",</span></span>
<span id="cb22-284"><a href="#cb22-284"></a><span class="in">          "        scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-285"><a href="#cb22-285"></a><span class="in">          "        late = scm[\"latest\"]",</span></span>
<span id="cb22-286"><a href="#cb22-286"></a><span class="in">          "        curr = scm[\"commit\"]",</span></span>
<span id="cb22-287"><a href="#cb22-287"></a><span class="in">          "        old_fs = [f for f in curr[-1][\"init\"]] + [f for f in curr[-1][\"diff\"]]",</span></span>
<span id="cb22-288"><a href="#cb22-288"></a><span class="in">          "        new_fs = [f for f in fs if fs not in old_fs]",</span></span>
<span id="cb22-289"><a href="#cb22-289"></a><span class="in">          "        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}",</span></span>
<span id="cb22-290"><a href="#cb22-290"></a><span class="in">          "        # We use unified diff from difflib since it still works with patch.",</span></span>
<span id="cb22-291"><a href="#cb22-291"></a><span class="in">          "        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}",</span></span>
<span id="cb22-292"><a href="#cb22-292"></a><span class="in">          "        scm[\"latest\"] = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-293"><a href="#cb22-293"></a><span class="in">          "        scm[\"commit\"].append({\"init\": init, \"diff\": diff})",</span></span>
<span id="cb22-294"><a href="#cb22-294"></a><span class="in">          "        print(diff)",</span></span>
<span id="cb22-295"><a href="#cb22-295"></a><span class="in">          "        json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-296"><a href="#cb22-296"></a><span class="in">          "",</span></span>
<span id="cb22-297"><a href="#cb22-297"></a><span class="in">          "",</span></span>
<span id="cb22-298"><a href="#cb22-298"></a><span class="in">          "# pops latest without caching.",</span></span>
<span id="cb22-299"><a href="#cb22-299"></a><span class="in">          "# not gonna ether novel files, that seems pointless?",</span></span>
<span id="cb22-300"><a href="#cb22-300"></a><span class="in">          "def scrape():",</span></span>
<span id="cb22-301"><a href="#cb22-301"></a><span class="in">          "    (not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0) and exit()",</span></span>
<span id="cb22-302"><a href="#cb22-302"></a><span class="in">          "    [",</span></span>
<span id="cb22-303"><a href="#cb22-303"></a><span class="in">          "        open(k, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-304"><a href="#cb22-304"></a><span class="in">          "        for k, v in json.loads(open(SCM_NAME, \"r\").read())[\"latest\"].items()",</span></span>
<span id="cb22-305"><a href="#cb22-305"></a><span class="in">          "    ]",</span></span>
<span id="cb22-306"><a href="#cb22-306"></a><span class="in">          "",</span></span>
<span id="cb22-307"><a href="#cb22-307"></a><span class="in">          "",</span></span>
<span id="cb22-308"><a href="#cb22-308"></a><span class="in">          "# let's just roll back one, that's logically equivalent",</span></span>
<span id="cb22-309"><a href="#cb22-309"></a><span class="in">          "def revert():",</span></span>
<span id="cb22-310"><a href="#cb22-310"></a><span class="in">          "    scrape()",</span></span>
<span id="cb22-311"><a href="#cb22-311"></a><span class="in">          "    scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-312"><a href="#cb22-312"></a><span class="in">          "    late = scm[\"latest\"]",</span></span>
<span id="cb22-313"><a href="#cb22-313"></a><span class="in">          "    curr = scm[\"commit\"]",</span></span>
<span id="cb22-314"><a href="#cb22-314"></a><span class="in">          "    len(curr) &lt; 2 and exit()",</span></span>
<span id="cb22-315"><a href="#cb22-315"></a><span class="in">          "    last = curr.pop()[\"diff\"]",</span></span>
<span id="cb22-316"><a href="#cb22-316"></a><span class="in">          "    for k, v in last.items():",</span></span>
<span id="cb22-317"><a href="#cb22-317"></a><span class="in">          "        open(DIFF_NAME, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-318"><a href="#cb22-318"></a><span class="in">          "        os.system(\"patch -R \" + k + \" \" + DIFF_NAME)",</span></span>
<span id="cb22-319"><a href="#cb22-319"></a><span class="in">          "",</span></span>
<span id="cb22-320"><a href="#cb22-320"></a><span class="in">          "",</span></span>
<span id="cb22-321"><a href="#cb22-321"></a><span class="in">          "viewer = lambda: os.system(",</span></span>
<span id="cb22-322"><a href="#cb22-322"></a><span class="in">          "    \"jq . .scm\"",</span></span>
<span id="cb22-323"><a href="#cb22-323"></a><span class="in">          ")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))",</span></span>
<span id="cb22-324"><a href="#cb22-324"></a><span class="in">          "",</span></span>
<span id="cb22-325"><a href="#cb22-325"></a><span class="in">          "__name__ == \"__main__\" and len(sys.argv) == 2 and {",</span></span>
<span id="cb22-326"><a href="#cb22-326"></a><span class="in">          "    \"commit\": commit,",</span></span>
<span id="cb22-327"><a href="#cb22-327"></a><span class="in">          "    \"scrape\": scrape,",</span></span>
<span id="cb22-328"><a href="#cb22-328"></a><span class="in">          "    \"revert\": revert,",</span></span>
<span id="cb22-329"><a href="#cb22-329"></a><span class="in">          "    \"viewer\": viewer,",</span></span>
<span id="cb22-330"><a href="#cb22-330"></a><span class="in">          "}[sys.argv[1]]()"</span></span>
<span id="cb22-331"><a href="#cb22-331"></a><span class="in">        ]</span></span>
<span id="cb22-332"><a href="#cb22-332"></a><span class="in">      },</span></span>
<span id="cb22-333"><a href="#cb22-333"></a><span class="in">      "diff": {}</span></span>
<span id="cb22-334"><a href="#cb22-334"></a><span class="in">    },</span></span>
<span id="cb22-335"><a href="#cb22-335"></a><span class="in">    {</span></span>
<span id="cb22-336"><a href="#cb22-336"></a><span class="in">      "init": {},</span></span>
<span id="cb22-337"><a href="#cb22-337"></a><span class="in">      "diff": {</span></span>
<span id="cb22-338"><a href="#cb22-338"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-339"><a href="#cb22-339"></a><span class="in">          "---",</span></span>
<span id="cb22-340"><a href="#cb22-340"></a><span class="in">          "+++",</span></span>
<span id="cb22-341"><a href="#cb22-341"></a><span class="in">          "@@ -71,3 +71,5 @@",</span></span>
<span id="cb22-342"><a href="#cb22-342"></a><span class="in">          "\"revert\": revert,",</span></span>
<span id="cb22-343"><a href="#cb22-343"></a><span class="in">          "\"viewer\": viewer,",</span></span>
<span id="cb22-344"><a href="#cb22-344"></a><span class="in">          "}[sys.argv[1]]()",</span></span>
<span id="cb22-345"><a href="#cb22-345"></a><span class="in">          "+",</span></span>
<span id="cb22-346"><a href="#cb22-346"></a><span class="in">          "+# Trivial Comment"</span></span>
<span id="cb22-347"><a href="#cb22-347"></a><span class="in">        ]</span></span>
<span id="cb22-348"><a href="#cb22-348"></a><span class="in">      }</span></span>
<span id="cb22-349"><a href="#cb22-349"></a><span class="in">    },</span></span>
<span id="cb22-350"><a href="#cb22-350"></a><span class="in">    {</span></span>
<span id="cb22-351"><a href="#cb22-351"></a><span class="in">      "init": {},</span></span>
<span id="cb22-352"><a href="#cb22-352"></a><span class="in">      "diff": {</span></span>
<span id="cb22-353"><a href="#cb22-353"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-354"><a href="#cb22-354"></a><span class="in">          "---",</span></span>
<span id="cb22-355"><a href="#cb22-355"></a><span class="in">          "+++",</span></span>
<span id="cb22-356"><a href="#cb22-356"></a><span class="in">          "@@ -6,7 +6,7 @@",</span></span>
<span id="cb22-357"><a href="#cb22-357"></a><span class="in">          " DIFF_NAME = \".diff\"",</span></span>
<span id="cb22-358"><a href="#cb22-358"></a><span class="in">          "",</span></span>
<span id="cb22-359"><a href="#cb22-359"></a><span class="in">          " # diff helper",</span></span>
<span id="cb22-360"><a href="#cb22-360"></a><span class="in">          "-diff_lines = lambda ls_0, ls_1: [line.strip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-361"><a href="#cb22-361"></a><span class="in">          "+diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-362"><a href="#cb22-362"></a><span class="in">          "",</span></span>
<span id="cb22-363"><a href="#cb22-363"></a><span class="in">          " # saves current version to .scm",</span></span>
<span id="cb22-364"><a href="#cb22-364"></a><span class="in">          " def commit():"</span></span>
<span id="cb22-365"><a href="#cb22-365"></a><span class="in">        ]</span></span>
<span id="cb22-366"><a href="#cb22-366"></a><span class="in">      }</span></span>
<span id="cb22-367"><a href="#cb22-367"></a><span class="in">    },</span></span>
<span id="cb22-368"><a href="#cb22-368"></a><span class="in">    {</span></span>
<span id="cb22-369"><a href="#cb22-369"></a><span class="in">      "init": {},</span></span>
<span id="cb22-370"><a href="#cb22-370"></a><span class="in">      "diff": {</span></span>
<span id="cb22-371"><a href="#cb22-371"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-372"><a href="#cb22-372"></a><span class="in">          "---",</span></span>
<span id="cb22-373"><a href="#cb22-373"></a><span class="in">          "+++",</span></span>
<span id="cb22-374"><a href="#cb22-374"></a><span class="in">          "@@ -34,7 +34,6 @@",</span></span>
<span id="cb22-375"><a href="#cb22-375"></a><span class="in">          "         diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}",</span></span>
<span id="cb22-376"><a href="#cb22-376"></a><span class="in">          "         scm[\"latest\"] = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-377"><a href="#cb22-377"></a><span class="in">          "         scm[\"commit\"].append({\"init\": init, \"diff\": diff})",</span></span>
<span id="cb22-378"><a href="#cb22-378"></a><span class="in">          "-        print(diff)",</span></span>
<span id="cb22-379"><a href="#cb22-379"></a><span class="in">          "         json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-380"><a href="#cb22-380"></a><span class="in">          "",</span></span>
<span id="cb22-381"><a href="#cb22-381"></a><span class="in">          ""</span></span>
<span id="cb22-382"><a href="#cb22-382"></a><span class="in">        ]</span></span>
<span id="cb22-383"><a href="#cb22-383"></a><span class="in">      }</span></span>
<span id="cb22-384"><a href="#cb22-384"></a><span class="in">    },</span></span>
<span id="cb22-385"><a href="#cb22-385"></a><span class="in">    {</span></span>
<span id="cb22-386"><a href="#cb22-386"></a><span class="in">      "init": {},</span></span>
<span id="cb22-387"><a href="#cb22-387"></a><span class="in">      "diff": {</span></span>
<span id="cb22-388"><a href="#cb22-388"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-389"><a href="#cb22-389"></a><span class="in">          "---",</span></span>
<span id="cb22-390"><a href="#cb22-390"></a><span class="in">          "+++",</span></span>
<span id="cb22-391"><a href="#cb22-391"></a><span class="in">          "@@ -70,5 +70,3 @@",</span></span>
<span id="cb22-392"><a href="#cb22-392"></a><span class="in">          "     \"revert\": revert,",</span></span>
<span id="cb22-393"><a href="#cb22-393"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-394"><a href="#cb22-394"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-395"><a href="#cb22-395"></a><span class="in">          "-",</span></span>
<span id="cb22-396"><a href="#cb22-396"></a><span class="in">          "-# Trivial Comment"</span></span>
<span id="cb22-397"><a href="#cb22-397"></a><span class="in">        ]</span></span>
<span id="cb22-398"><a href="#cb22-398"></a><span class="in">      }</span></span>
<span id="cb22-399"><a href="#cb22-399"></a><span class="in">    },</span></span>
<span id="cb22-400"><a href="#cb22-400"></a><span class="in">    {</span></span>
<span id="cb22-401"><a href="#cb22-401"></a><span class="in">      "init": {},</span></span>
<span id="cb22-402"><a href="#cb22-402"></a><span class="in">      "diff": {</span></span>
<span id="cb22-403"><a href="#cb22-403"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-404"><a href="#cb22-404"></a><span class="in">          "---",</span></span>
<span id="cb22-405"><a href="#cb22-405"></a><span class="in">          "+++",</span></span>
<span id="cb22-406"><a href="#cb22-406"></a><span class="in">          "@@ -70,3 +70,7 @@",</span></span>
<span id="cb22-407"><a href="#cb22-407"></a><span class="in">          "     \"revert\": revert,",</span></span>
<span id="cb22-408"><a href="#cb22-408"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-409"><a href="#cb22-409"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-410"><a href="#cb22-410"></a><span class="in">          "+",</span></span>
<span id="cb22-411"><a href="#cb22-411"></a><span class="in">          "+# Trivial Comment",</span></span>
<span id="cb22-412"><a href="#cb22-412"></a><span class="in">          "+",</span></span>
<span id="cb22-413"><a href="#cb22-413"></a><span class="in">          "+"</span></span>
<span id="cb22-414"><a href="#cb22-414"></a><span class="in">        ]</span></span>
<span id="cb22-415"><a href="#cb22-415"></a><span class="in">      }</span></span>
<span id="cb22-416"><a href="#cb22-416"></a><span class="in">    },</span></span>
<span id="cb22-417"><a href="#cb22-417"></a><span class="in">    {</span></span>
<span id="cb22-418"><a href="#cb22-418"></a><span class="in">      "init": {},</span></span>
<span id="cb22-419"><a href="#cb22-419"></a><span class="in">      "diff": {</span></span>
<span id="cb22-420"><a href="#cb22-420"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-421"><a href="#cb22-421"></a><span class="in">          "---",</span></span>
<span id="cb22-422"><a href="#cb22-422"></a><span class="in">          "+++",</span></span>
<span id="cb22-423"><a href="#cb22-423"></a><span class="in">          "@@ -71,6 +71,5 @@",</span></span>
<span id="cb22-424"><a href="#cb22-424"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-425"><a href="#cb22-425"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-426"><a href="#cb22-426"></a><span class="in">          "",</span></span>
<span id="cb22-427"><a href="#cb22-427"></a><span class="in">          "-# Trivial Comment",</span></span>
<span id="cb22-428"><a href="#cb22-428"></a><span class="in">          "",</span></span>
<span id="cb22-429"><a href="#cb22-429"></a><span class="in">          ""</span></span>
<span id="cb22-430"><a href="#cb22-430"></a><span class="in">        ]</span></span>
<span id="cb22-431"><a href="#cb22-431"></a><span class="in">      }</span></span>
<span id="cb22-432"><a href="#cb22-432"></a><span class="in">    },</span></span>
<span id="cb22-433"><a href="#cb22-433"></a><span class="in">    {</span></span>
<span id="cb22-434"><a href="#cb22-434"></a><span class="in">      "init": {</span></span>
<span id="cb22-435"><a href="#cb22-435"></a><span class="in">        "/home/user/tmp/scmpy/scm.py.orig": [</span></span>
<span id="cb22-436"><a href="#cb22-436"></a><span class="in">          "#!/usr/bin/env python3",</span></span>
<span id="cb22-437"><a href="#cb22-437"></a><span class="in">          "",</span></span>
<span id="cb22-438"><a href="#cb22-438"></a><span class="in">          "import os, sys, json, subprocess, difflib",</span></span>
<span id="cb22-439"><a href="#cb22-439"></a><span class="in">          "",</span></span>
<span id="cb22-440"><a href="#cb22-440"></a><span class="in">          "SCM_NAME = \".scm\"",</span></span>
<span id="cb22-441"><a href="#cb22-441"></a><span class="in">          "DIFF_NAME = \".diff\"",</span></span>
<span id="cb22-442"><a href="#cb22-442"></a><span class="in">          "",</span></span>
<span id="cb22-443"><a href="#cb22-443"></a><span class="in">          "# diff helper",</span></span>
<span id="cb22-444"><a href="#cb22-444"></a><span class="in">          "diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]",</span></span>
<span id="cb22-445"><a href="#cb22-445"></a><span class="in">          "",</span></span>
<span id="cb22-446"><a href="#cb22-446"></a><span class="in">          "# saves current version to .scm",</span></span>
<span id="cb22-447"><a href="#cb22-447"></a><span class="in">          "def commit():",</span></span>
<span id="cb22-448"><a href="#cb22-448"></a><span class="in">          "    # Get all files that aren't hidden",</span></span>
<span id="cb22-449"><a href="#cb22-449"></a><span class="in">          "    tree = [node for node in os.walk(os.getcwd()) if \".\" not in node[0]]",</span></span>
<span id="cb22-450"><a href="#cb22-450"></a><span class="in">          "    fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != \".\"]",</span></span>
<span id="cb22-451"><a href="#cb22-451"></a><span class="in">          "",</span></span>
<span id="cb22-452"><a href="#cb22-452"></a><span class="in">          "    # Get or create .scm file",</span></span>
<span id="cb22-453"><a href="#cb22-453"></a><span class="in">          "    if not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0:",</span></span>
<span id="cb22-454"><a href="#cb22-454"></a><span class="in">          "        # create",</span></span>
<span id="cb22-455"><a href="#cb22-455"></a><span class="in">          "        latest = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-456"><a href="#cb22-456"></a><span class="in">          "        json.dump(",</span></span>
<span id="cb22-457"><a href="#cb22-457"></a><span class="in">          "            {\"latest\": latest, \"commit\": [{\"init\": latest, \"diff\": {}}]},",</span></span>
<span id="cb22-458"><a href="#cb22-458"></a><span class="in">          "            open(SCM_NAME, \"w\"),",</span></span>
<span id="cb22-459"><a href="#cb22-459"></a><span class="in">          "        )",</span></span>
<span id="cb22-460"><a href="#cb22-460"></a><span class="in">          "    else:",</span></span>
<span id="cb22-461"><a href="#cb22-461"></a><span class="in">          "        # get",</span></span>
<span id="cb22-462"><a href="#cb22-462"></a><span class="in">          "        scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-463"><a href="#cb22-463"></a><span class="in">          "        late = scm[\"latest\"]",</span></span>
<span id="cb22-464"><a href="#cb22-464"></a><span class="in">          "        curr = scm[\"commit\"]",</span></span>
<span id="cb22-465"><a href="#cb22-465"></a><span class="in">          "        old_fs = [f for f in curr[-1][\"init\"]] + [f for f in curr[-1][\"diff\"]]",</span></span>
<span id="cb22-466"><a href="#cb22-466"></a><span class="in">          "        new_fs = [f for f in fs if fs not in old_fs]",</span></span>
<span id="cb22-467"><a href="#cb22-467"></a><span class="in">          "        init = {f: open(f).read().splitlines() for f in new_fs if f not in old_fs}",</span></span>
<span id="cb22-468"><a href="#cb22-468"></a><span class="in">          "        # We use unified diff from difflib since it still works with patch.",</span></span>
<span id="cb22-469"><a href="#cb22-469"></a><span class="in">          "        diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}",</span></span>
<span id="cb22-470"><a href="#cb22-470"></a><span class="in">          "        scm[\"latest\"] = {f: open(f).read().splitlines() for f in fs}",</span></span>
<span id="cb22-471"><a href="#cb22-471"></a><span class="in">          "        scm[\"commit\"].append({\"init\": init, \"diff\": diff})",</span></span>
<span id="cb22-472"><a href="#cb22-472"></a><span class="in">          "        json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-473"><a href="#cb22-473"></a><span class="in">          "",</span></span>
<span id="cb22-474"><a href="#cb22-474"></a><span class="in">          "",</span></span>
<span id="cb22-475"><a href="#cb22-475"></a><span class="in">          "# pops latest without caching.",</span></span>
<span id="cb22-476"><a href="#cb22-476"></a><span class="in">          "# not gonna ether novel files, that seems pointless?",</span></span>
<span id="cb22-477"><a href="#cb22-477"></a><span class="in">          "def scrape():",</span></span>
<span id="cb22-478"><a href="#cb22-478"></a><span class="in">          "    (not os.path.isfile(SCM_NAME) or os.path.getsize(\".scm\") == 0) and exit()",</span></span>
<span id="cb22-479"><a href="#cb22-479"></a><span class="in">          "    [",</span></span>
<span id="cb22-480"><a href="#cb22-480"></a><span class="in">          "        open(k, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-481"><a href="#cb22-481"></a><span class="in">          "        for k, v in json.loads(open(SCM_NAME, \"r\").read())[\"latest\"].items()",</span></span>
<span id="cb22-482"><a href="#cb22-482"></a><span class="in">          "    ]",</span></span>
<span id="cb22-483"><a href="#cb22-483"></a><span class="in">          "",</span></span>
<span id="cb22-484"><a href="#cb22-484"></a><span class="in">          "",</span></span>
<span id="cb22-485"><a href="#cb22-485"></a><span class="in">          "# let's just roll back one, that's logically equivalent",</span></span>
<span id="cb22-486"><a href="#cb22-486"></a><span class="in">          "def revert():",</span></span>
<span id="cb22-487"><a href="#cb22-487"></a><span class="in">          "    scrape()",</span></span>
<span id="cb22-488"><a href="#cb22-488"></a><span class="in">          "    scm = json.loads(open(SCM_NAME, \"r\").read())",</span></span>
<span id="cb22-489"><a href="#cb22-489"></a><span class="in">          "    late = scm[\"latest\"]",</span></span>
<span id="cb22-490"><a href="#cb22-490"></a><span class="in">          "    curr = scm[\"commit\"]",</span></span>
<span id="cb22-491"><a href="#cb22-491"></a><span class="in">          "    len(curr) &lt; 2 and exit()",</span></span>
<span id="cb22-492"><a href="#cb22-492"></a><span class="in">          "    last = curr.pop()[\"diff\"]",</span></span>
<span id="cb22-493"><a href="#cb22-493"></a><span class="in">          "    for k, v in last.items():",</span></span>
<span id="cb22-494"><a href="#cb22-494"></a><span class="in">          "        open(DIFF_NAME, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-495"><a href="#cb22-495"></a><span class="in">          "        os.system(\"patch -R \" + k + \" \" + DIFF_NAME)",</span></span>
<span id="cb22-496"><a href="#cb22-496"></a><span class="in">          "",</span></span>
<span id="cb22-497"><a href="#cb22-497"></a><span class="in">          "",</span></span>
<span id="cb22-498"><a href="#cb22-498"></a><span class="in">          "viewer = lambda: os.system(",</span></span>
<span id="cb22-499"><a href="#cb22-499"></a><span class="in">          "    \"jq . .scm\"",</span></span>
<span id="cb22-500"><a href="#cb22-500"></a><span class="in">          ")  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))",</span></span>
<span id="cb22-501"><a href="#cb22-501"></a><span class="in">          "",</span></span>
<span id="cb22-502"><a href="#cb22-502"></a><span class="in">          "__name__ == \"__main__\" and len(sys.argv) == 2 and {",</span></span>
<span id="cb22-503"><a href="#cb22-503"></a><span class="in">          "    \"commit\": commit,",</span></span>
<span id="cb22-504"><a href="#cb22-504"></a><span class="in">          "    \"scrape\": scrape,",</span></span>
<span id="cb22-505"><a href="#cb22-505"></a><span class="in">          "    \"revert\": revert,",</span></span>
<span id="cb22-506"><a href="#cb22-506"></a><span class="in">          "    \"viewer\": viewer,",</span></span>
<span id="cb22-507"><a href="#cb22-507"></a><span class="in">          "}[sys.argv[1]]()",</span></span>
<span id="cb22-508"><a href="#cb22-508"></a><span class="in">          "",</span></span>
<span id="cb22-509"><a href="#cb22-509"></a><span class="in">          ""</span></span>
<span id="cb22-510"><a href="#cb22-510"></a><span class="in">        ]</span></span>
<span id="cb22-511"><a href="#cb22-511"></a><span class="in">      },</span></span>
<span id="cb22-512"><a href="#cb22-512"></a><span class="in">      "diff": {</span></span>
<span id="cb22-513"><a href="#cb22-513"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-514"><a href="#cb22-514"></a><span class="in">          "---",</span></span>
<span id="cb22-515"><a href="#cb22-515"></a><span class="in">          "+++",</span></span>
<span id="cb22-516"><a href="#cb22-516"></a><span class="in">          "@@ -58,7 +58,7 @@",</span></span>
<span id="cb22-517"><a href="#cb22-517"></a><span class="in">          "     for k, v in last.items():",</span></span>
<span id="cb22-518"><a href="#cb22-518"></a><span class="in">          "         open(DIFF_NAME, \"w\").write(\"\\n\".join(v))",</span></span>
<span id="cb22-519"><a href="#cb22-519"></a><span class="in">          "         os.system(\"patch -R \" + k + \" \" + DIFF_NAME)",</span></span>
<span id="cb22-520"><a href="#cb22-520"></a><span class="in">          "-",</span></span>
<span id="cb22-521"><a href="#cb22-521"></a><span class="in">          "+    json.dump(scm, open(SCM_NAME, \"w\"))",</span></span>
<span id="cb22-522"><a href="#cb22-522"></a><span class="in">          "",</span></span>
<span id="cb22-523"><a href="#cb22-523"></a><span class="in">          " viewer = lambda: os.system(",</span></span>
<span id="cb22-524"><a href="#cb22-524"></a><span class="in">          "     \"jq . .scm\"",</span></span>
<span id="cb22-525"><a href="#cb22-525"></a><span class="in">          "@@ -71,5 +71,5 @@",</span></span>
<span id="cb22-526"><a href="#cb22-526"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-527"><a href="#cb22-527"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-528"><a href="#cb22-528"></a><span class="in">          "",</span></span>
<span id="cb22-529"><a href="#cb22-529"></a><span class="in">          "+# Trivial Comment",</span></span>
<span id="cb22-530"><a href="#cb22-530"></a><span class="in">          "",</span></span>
<span id="cb22-531"><a href="#cb22-531"></a><span class="in">          "-"</span></span>
<span id="cb22-532"><a href="#cb22-532"></a><span class="in">        ]</span></span>
<span id="cb22-533"><a href="#cb22-533"></a><span class="in">      }</span></span>
<span id="cb22-534"><a href="#cb22-534"></a><span class="in">    },</span></span>
<span id="cb22-535"><a href="#cb22-535"></a><span class="in">    {</span></span>
<span id="cb22-536"><a href="#cb22-536"></a><span class="in">      "init": {},</span></span>
<span id="cb22-537"><a href="#cb22-537"></a><span class="in">      "diff": {</span></span>
<span id="cb22-538"><a href="#cb22-538"></a><span class="in">        "/home/user/tmp/scmpy/scm.py.orig": [</span></span>
<span id="cb22-539"><a href="#cb22-539"></a><span class="in">          "---",</span></span>
<span id="cb22-540"><a href="#cb22-540"></a><span class="in">          "+++",</span></span>
<span id="cb22-541"><a href="#cb22-541"></a><span class="in">          "@@ -71,4 +71,3 @@",</span></span>
<span id="cb22-542"><a href="#cb22-542"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-543"><a href="#cb22-543"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-544"><a href="#cb22-544"></a><span class="in">          "",</span></span>
<span id="cb22-545"><a href="#cb22-545"></a><span class="in">          "-"</span></span>
<span id="cb22-546"><a href="#cb22-546"></a><span class="in">        ],</span></span>
<span id="cb22-547"><a href="#cb22-547"></a><span class="in">        "/home/user/tmp/scmpy/scm.py": [</span></span>
<span id="cb22-548"><a href="#cb22-548"></a><span class="in">          "---",</span></span>
<span id="cb22-549"><a href="#cb22-549"></a><span class="in">          "+++",</span></span>
<span id="cb22-550"><a href="#cb22-550"></a><span class="in">          "@@ -64,6 +64,8 @@",</span></span>
<span id="cb22-551"><a href="#cb22-551"></a><span class="in">          "     \"jq . .scm\"",</span></span>
<span id="cb22-552"><a href="#cb22-552"></a><span class="in">          " )  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))",</span></span>
<span id="cb22-553"><a href="#cb22-553"></a><span class="in">          "",</span></span>
<span id="cb22-554"><a href="#cb22-554"></a><span class="in">          "+# Trivial Comment",</span></span>
<span id="cb22-555"><a href="#cb22-555"></a><span class="in">          "+",</span></span>
<span id="cb22-556"><a href="#cb22-556"></a><span class="in">          " __name__ == \"__main__\" and len(sys.argv) == 2 and {",</span></span>
<span id="cb22-557"><a href="#cb22-557"></a><span class="in">          "     \"commit\": commit,",</span></span>
<span id="cb22-558"><a href="#cb22-558"></a><span class="in">          "     \"scrape\": scrape,",</span></span>
<span id="cb22-559"><a href="#cb22-559"></a><span class="in">          "@@ -71,9 +73,3 @@",</span></span>
<span id="cb22-560"><a href="#cb22-560"></a><span class="in">          "     \"viewer\": viewer,",</span></span>
<span id="cb22-561"><a href="#cb22-561"></a><span class="in">          " }[sys.argv[1]]()",</span></span>
<span id="cb22-562"><a href="#cb22-562"></a><span class="in">          "",</span></span>
<span id="cb22-563"><a href="#cb22-563"></a><span class="in">          "-# Trivial Comment",</span></span>
<span id="cb22-564"><a href="#cb22-564"></a><span class="in">          "-",</span></span>
<span id="cb22-565"><a href="#cb22-565"></a><span class="in">          "-# Another",</span></span>
<span id="cb22-566"><a href="#cb22-566"></a><span class="in">          "-",</span></span>
<span id="cb22-567"><a href="#cb22-567"></a><span class="in">          "-",</span></span>
<span id="cb22-568"><a href="#cb22-568"></a><span class="in">          "-"</span></span>
<span id="cb22-569"><a href="#cb22-569"></a><span class="in">        ]</span></span>
<span id="cb22-570"><a href="#cb22-570"></a><span class="in">      }</span></span>
<span id="cb22-571"><a href="#cb22-571"></a><span class="in">    }</span></span>
<span id="cb22-572"><a href="#cb22-572"></a><span class="in">  ]</span></span>
<span id="cb22-573"><a href="#cb22-573"></a><span class="in">}</span></span>
<span id="cb22-574"><a href="#cb22-574"></a><span class="in">```</span></span>
<span id="cb22-575"><a href="#cb22-575"></a></span>
<span id="cb22-576"><a href="#cb22-576"></a><span class="fu">## Design Decision</span></span>
<span id="cb22-577"><a href="#cb22-577"></a></span>
<span id="cb22-578"><a href="#cb22-578"></a><span class="at">&gt; Decide whether you want to navigate a file system and crush text and be rad as heck, or learn </span><span class="in">`serde`</span><span class="at">, toss everything in a single file, and be cool as heck</span></span>
<span id="cb22-579"><a href="#cb22-579"></a></span>
<span id="cb22-580"><a href="#cb22-580"></a><span class="ss">- </span>I liked JSON a lot for this, but there's no question there's benefits to using the file system!</span>
<span id="cb22-581"><a href="#cb22-581"></a><span class="ss">    - </span>But... what if you *don't have a file system* (is that CS-371: Operating Systems' theme?)</span>
<span id="cb22-582"><a href="#cb22-582"></a>    </span>
<span id="cb22-583"><a href="#cb22-583"></a><span class="fu">## Aside: Python</span></span>
<span id="cb22-584"><a href="#cb22-584"></a></span>
<span id="cb22-585"><a href="#cb22-585"></a><span class="ss">- </span>Python is cringe or bad or whatever, I just used a language you knew to give a reference that is "self-documentating".</span>
<span id="cb22-586"><a href="#cb22-586"></a><span class="ss">- </span>It also makes a few system calls, directly using <span class="in">`patch`</span> for example (this will probably explode on Windows, which is a you-problem).</span>
<span id="cb22-587"><a href="#cb22-587"></a></span>
<span id="cb22-588"><a href="#cb22-588"></a><span class="fu">## Python Quality</span></span>
<span id="cb22-589"><a href="#cb22-589"></a></span>
<span id="cb22-590"><a href="#cb22-590"></a><span class="ss">- </span>I also put some effort into making the Python "look like Python" so all examples here are:</span>
<span id="cb22-591"><a href="#cb22-591"></a><span class="ss">    - </span>Open source.</span>
<span id="cb22-592"><a href="#cb22-592"></a><span class="ss">    - </span>Licensed GPLv3 (ask me after class)</span>
<span id="cb22-593"><a href="#cb22-593"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">`black`</span><span class="co">](https://github.com/psf/black)</span> formatted.</span>
<span id="cb22-594"><a href="#cb22-594"></a>    </span>
<span id="cb22-595"><a href="#cb22-595"></a><span class="fu">## Differences</span></span>
<span id="cb22-596"><a href="#cb22-596"></a>    </span>
<span id="cb22-597"><a href="#cb22-597"></a><span class="ss">- </span>You shouldn't use system calls like <span class="in">`patch`</span></span>
<span id="cb22-598"><a href="#cb22-598"></a><span class="ss">    - </span>Those aren't written in Rust, and therefore we can't use them.</span>
<span id="cb22-599"><a href="#cb22-599"></a><span class="ss">- </span>You are writing actually usable code and should use a license and <span class="in">`cargo fmt`</span></span>
<span id="cb22-600"><a href="#cb22-600"></a><span class="ss">    - </span>You'll see why formatting is so nice as soon as you start looking a SCM diffs!</span>
<span id="cb22-601"><a href="#cb22-601"></a></span>
<span id="cb22-602"><a href="#cb22-602"></a><span class="fu"># Requirements</span></span>
<span id="cb22-603"><a href="#cb22-603"></a></span>
<span id="cb22-604"><a href="#cb22-604"></a><span class="fu">## An SCM</span></span>
<span id="cb22-605"><a href="#cb22-605"></a></span>
<span id="cb22-606"><a href="#cb22-606"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">Version control (also known as revision control, source control, and source code management) is the software engineering practice of controlling, organizing, and tracking different versions in history of computer files; primarily source code text files, but generally any type of file.</span><span class="co">](https://en.wikipedia.org/wiki/Version_control)</span></span>
<span id="cb22-607"><a href="#cb22-607"></a></span>
<span id="cb22-608"><a href="#cb22-608"></a><span class="fu">## A Minimal SCM</span></span>
<span id="cb22-609"><a href="#cb22-609"></a></span>
<span id="cb22-610"><a href="#cb22-610"></a><span class="at">&gt; Version control includes options to view old versions and to revert a file to a previous version. </span></span>
<span id="cb22-611"><a href="#cb22-611"></a></span>
<span id="cb22-612"><a href="#cb22-612"></a><span class="ss">- </span>For the final, we implement an SCM that does two things:</span>
<span id="cb22-613"><a href="#cb22-613"></a><span class="ss">    - </span>Saves old versions of files, somehow</span>
<span id="cb22-614"><a href="#cb22-614"></a><span class="ss">    - </span>Can "roll back" changes to files to older versions.</span>
<span id="cb22-615"><a href="#cb22-615"></a><span class="ss">    - </span>Provides some form of visibility into past files</span>
<span id="cb22-616"><a href="#cb22-616"></a>    </span>
<span id="cb22-617"><a href="#cb22-617"></a><span class="fu">## My terminology</span></span>
<span id="cb22-618"><a href="#cb22-618"></a></span>
<span id="cb22-619"><a href="#cb22-619"></a><span class="ss">- </span>I use the following verbs, ish, to describe these:</span>
<span id="cb22-620"><a href="#cb22-620"></a><span class="ss">    - </span><span class="in">`commit`</span> saves the current version of the files under control/management</span>
<span id="cb22-621"><a href="#cb22-621"></a><span class="ss">    - </span><span class="in">`revert`</span> overwrites the *current* version with the *previous* version.</span>
<span id="cb22-622"><a href="#cb22-622"></a><span class="ss">- </span>I am not a pretty-print enthusiast and simply dump JSON unaltered to meet the "visibility" requirement.</span>
<span id="cb22-623"><a href="#cb22-623"></a><span class="ss">    - </span>This can be a fun thing to extend to look nicer if you want!</span>
<span id="cb22-624"><a href="#cb22-624"></a><span class="ss">    - </span>Check out e.g. <span class="in">`git log`</span></span>
<span id="cb22-625"><a href="#cb22-625"></a>    </span>
<span id="cb22-626"><a href="#cb22-626"></a><span class="fu">## My Commit</span></span>
<span id="cb22-627"><a href="#cb22-627"></a></span>
<span id="cb22-628"><a href="#cb22-628"></a><span class="ss">- </span>Read every non-hidden (non-<span class="in">`.`</span> prefixed) file and folder in the current path, recursively.</span>
<span id="cb22-629"><a href="#cb22-629"></a><span class="ss">- </span>Check to see if the system is already under version control by checking for a <span class="in">`.scm`</span> file</span>
<span id="cb22-630"><a href="#cb22-630"></a><span class="ss">    - </span>In the case the file (vs. JSON) implementation, this would be a folder, like <span class="in">`.git`</span></span>
<span id="cb22-631"><a href="#cb22-631"></a><span class="ss">- </span>Either create a JSON file containing all file contents if <span class="in">`.scm`</span> does not exist, or</span>
<span id="cb22-632"><a href="#cb22-632"></a><span class="ss">- </span>Append a diff to the JSON file for every change.</span>
<span id="cb22-633"><a href="#cb22-633"></a>    </span>
<span id="cb22-634"><a href="#cb22-634"></a><span class="fu">## Design Decisions</span></span>
<span id="cb22-635"><a href="#cb22-635"></a></span>
<span id="cb22-636"><a href="#cb22-636"></a><span class="ss">- </span>This is not a <span class="in">`git commit`</span>!</span>
<span id="cb22-637"><a href="#cb22-637"></a><span class="ss">- </span>Git has both <span class="in">`init`</span> and <span class="in">`add`</span> - I use neither</span>
<span id="cb22-638"><a href="#cb22-638"></a><span class="ss">    - </span>The first time commit is called, it runs an initializer instead of a standard commit.</span>
<span id="cb22-639"><a href="#cb22-639"></a><span class="ss">    - </span>All files are automatically included.</span>
<span id="cb22-640"><a href="#cb22-640"></a><span class="ss">- </span>You don't have to do either of these, but should probably provide an alias to similar to <span class="in">`./scm.py commit`</span> just to test equivalencies.</span>
<span id="cb22-641"><a href="#cb22-641"></a></span>
<span id="cb22-642"><a href="#cb22-642"></a><span class="fu">## Get All Files</span></span>
<span id="cb22-643"><a href="#cb22-643"></a></span>
<span id="cb22-644"><a href="#cb22-644"></a><span class="ss">- </span>I didn't even initially include commit in a function since it was the first thing I wrote!</span>
<span id="cb22-645"><a href="#cb22-645"></a><span class="ss">- </span>But now, it starts like this:</span>
<span id="cb22-646"><a href="#cb22-646"></a></span>
<span id="cb22-647"><a href="#cb22-647"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-648"><a href="#cb22-648"></a><span class="in"># Get all files that aren't hidden</span></span>
<span id="cb22-649"><a href="#cb22-649"></a><span class="in">tree = [node for node in os.walk(os.getcwd()) if "." not in node[0]]</span></span>
<span id="cb22-650"><a href="#cb22-650"></a><span class="in">fs = [os.path.join(node[0], n) for node in tree for n in node[2] if n[0] != "."]</span></span>
<span id="cb22-651"><a href="#cb22-651"></a><span class="in">```</span></span>
<span id="cb22-652"><a href="#cb22-652"></a></span>
<span id="cb22-653"><a href="#cb22-653"></a><span class="ss">- </span><span class="in">`fs`</span> is the Python list (so a Rust <span class="in">`Vec`</span>) that contains the *full paths* as strings of all non-hidden files, recursively.</span>
<span id="cb22-654"><a href="#cb22-654"></a><span class="ss">    - </span>Recursively means current directory and any sub-directories.</span>
<span id="cb22-655"><a href="#cb22-655"></a>    </span>
<span id="cb22-656"><a href="#cb22-656"></a><span class="fu">## Cases</span></span>
<span id="cb22-657"><a href="#cb22-657"></a></span>
<span id="cb22-658"><a href="#cb22-658"></a><span class="ss">- </span>I quickly check the file system for the presence of a hidden <span class="in">`.scm`</span> file (or folder) which I use to save versions.</span>
<span id="cb22-659"><a href="#cb22-659"></a></span>
<span id="cb22-660"><a href="#cb22-660"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-661"><a href="#cb22-661"></a><span class="in">if not os.path.isfile(SCM_NAME) or os.path.getsize(".scm") == 0:</span></span>
<span id="cb22-662"><a href="#cb22-662"></a><span class="in">```</span></span>
<span id="cb22-663"><a href="#cb22-663"></a></span>
<span id="cb22-664"><a href="#cb22-664"></a><span class="ss">- </span>You'll figure out in testing why you need this, and also why it is worthwhile to test if a file exists but is of size zero.</span>
<span id="cb22-665"><a href="#cb22-665"></a><span class="ss">    - </span>Any bad code between file opening and writing well-formed JSON will be very annoying.</span>
<span id="cb22-666"><a href="#cb22-666"></a><span class="ss">- </span>I'd expect a Rust <span class="in">`match`</span> here, but you do you!</span>
<span id="cb22-667"><a href="#cb22-667"></a></span>
<span id="cb22-668"><a href="#cb22-668"></a><span class="fu">## Aside: `.scm`</span></span>
<span id="cb22-669"><a href="#cb22-669"></a></span>
<span id="cb22-670"><a href="#cb22-670"></a><span class="ss">- </span>Git's hidden cache is called <span class="in">`.git`</span></span>
<span id="cb22-671"><a href="#cb22-671"></a><span class="ss">- </span>You don't have to call your SCM <span class="in">`scm`</span></span>
<span id="cb22-672"><a href="#cb22-672"></a><span class="ss">- </span>I just had two globals I used so it was easy to change:</span>
<span id="cb22-673"><a href="#cb22-673"></a></span>
<span id="cb22-674"><a href="#cb22-674"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-675"><a href="#cb22-675"></a><span class="in">SCM_NAME = ".scm"</span></span>
<span id="cb22-676"><a href="#cb22-676"></a><span class="in">DIFF_NAME = ".diff"</span></span>
<span id="cb22-677"><a href="#cb22-677"></a><span class="in">```</span></span>
<span id="cb22-678"><a href="#cb22-678"></a></span>
<span id="cb22-679"><a href="#cb22-679"></a><span class="ss">- </span>Obviously the code explodes if anything else uses those names, but <span class="in">`git`</span> gets away with it, so...</span>
<span id="cb22-680"><a href="#cb22-680"></a></span>
<span id="cb22-681"><a href="#cb22-681"></a><span class="fu">## Initializing</span></span>
<span id="cb22-682"><a href="#cb22-682"></a></span>
<span id="cb22-683"><a href="#cb22-683"></a><span class="ss">- </span>Initializing was straightforward.</span>
<span id="cb22-684"><a href="#cb22-684"></a><span class="ss">- </span>Rip every file, I did into lists of lines (prints out better) and slam it into a Python dictionary (so a Rust <span class="in">`HashMap`</span> or a <span class="in">`serde_json::Map`</span>)</span>
<span id="cb22-685"><a href="#cb22-685"></a><span class="ss">- </span>Then dump to the JSON formatted <span class="in">`.scm`</span> file.</span>
<span id="cb22-686"><a href="#cb22-686"></a></span>
<span id="cb22-687"><a href="#cb22-687"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-688"><a href="#cb22-688"></a><span class="in">latest = {f: open(f).read().splitlines() for f in fs}</span></span>
<span id="cb22-689"><a href="#cb22-689"></a><span class="in">json.dump(</span></span>
<span id="cb22-690"><a href="#cb22-690"></a><span class="in">    {"latest": latest, "commit": [{"init": latest, "diff": {}}]},</span></span>
<span id="cb22-691"><a href="#cb22-691"></a><span class="in">    open(SCM_NAME, "w"),</span></span>
<span id="cb22-692"><a href="#cb22-692"></a><span class="in">)</span></span>
<span id="cb22-693"><a href="#cb22-693"></a><span class="in">```</span></span>
<span id="cb22-694"><a href="#cb22-694"></a></span>
<span id="cb22-695"><a href="#cb22-695"></a><span class="fu">## Subleties</span></span>
<span id="cb22-696"><a href="#cb22-696"></a></span>
<span id="cb22-697"><a href="#cb22-697"></a><span class="ss">- </span>I do two things here that make more sense as you get further in the project:</span>
<span id="cb22-698"><a href="#cb22-698"></a><span class="ss">    - </span>I create a "latest" key, which stores the most recent <span class="in">`commit`</span>ed version of all files.</span>
<span id="cb22-699"><a href="#cb22-699"></a><span class="ss">    - </span>I *separately* create a "commit" key, which stores a JSON array (so a Python list or Rust <span class="in">`Vec`</span>)</span>
<span id="cb22-700"><a href="#cb22-700"></a><span class="ss">        - </span>This list contains itself an "init" key, for new files, and a "diff" key, for changed files.</span>
<span id="cb22-701"><a href="#cb22-701"></a><span class="ss">- </span>Think about why you would want to get these things separate!</span>
<span id="cb22-702"><a href="#cb22-702"></a></span>
<span id="cb22-703"><a href="#cb22-703"></a><span class="fu">## Accessing `.scm`</span></span>
<span id="cb22-704"><a href="#cb22-704"></a></span>
<span id="cb22-705"><a href="#cb22-705"></a><span class="ss">- </span>Once some commit has been made, latter submits require appending to the JSON file.</span>
<span id="cb22-706"><a href="#cb22-706"></a><span class="ss">    - </span>Which of course I do by completely overwriting it, because that is easier.</span>
<span id="cb22-707"><a href="#cb22-707"></a><span class="ss">- </span>First I read it in a slice it up.</span>
<span id="cb22-708"><a href="#cb22-708"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-709"><a href="#cb22-709"></a><span class="in">scm = json.loads(open(SCM_NAME, "r").read())</span></span>
<span id="cb22-710"><a href="#cb22-710"></a><span class="in">late = scm["latest"]</span></span>
<span id="cb22-711"><a href="#cb22-711"></a><span class="in">curr = scm["commit"]</span></span>
<span id="cb22-712"><a href="#cb22-712"></a><span class="in">```</span></span>
<span id="cb22-713"><a href="#cb22-713"></a><span class="ss">- </span>Hard to understate how much nicer it is to allow yourself some niceties like caching the latest files.</span>
<span id="cb22-714"><a href="#cb22-714"></a></span>
<span id="cb22-715"><a href="#cb22-715"></a><span class="fu">## Checking for files</span></span>
<span id="cb22-716"><a href="#cb22-716"></a></span>
<span id="cb22-717"><a href="#cb22-717"></a><span class="ss">- </span>At this point, I already determined <span class="in">`fs`</span> - the current eligible files.</span>
<span id="cb22-718"><a href="#cb22-718"></a><span class="ss">- </span>I also check:</span>
<span id="cb22-719"><a href="#cb22-719"></a><span class="ss">    - </span>What files are already under version control, and</span>
<span id="cb22-720"><a href="#cb22-720"></a><span class="ss">    - </span>Which ones aren't.</span>
<span id="cb22-721"><a href="#cb22-721"></a>    </span>
<span id="cb22-722"><a href="#cb22-722"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-723"><a href="#cb22-723"></a><span class="in">old_fs = [f for f in curr[-1]["init"]] + [f for f in curr[-1]["diff"]]</span></span>
<span id="cb22-724"><a href="#cb22-724"></a><span class="in">new_fs = [f for f in fs if fs not in old_fs]</span></span>
<span id="cb22-725"><a href="#cb22-725"></a><span class="in">```</span></span>
<span id="cb22-726"><a href="#cb22-726"></a></span>
<span id="cb22-727"><a href="#cb22-727"></a><span class="fu">## Aside: Diff</span></span>
<span id="cb22-728"><a href="#cb22-728"></a></span>
<span id="cb22-729"><a href="#cb22-729"></a><span class="ss">- </span>The <span class="in">`diff`</span> I like can't be used gracefully from Python.</span>
<span id="cb22-730"><a href="#cb22-730"></a><span class="ss">    - </span>Either <span class="in">`diff`</span> in a <span class="in">`subprocess.check_output`</span>, or</span>
<span id="cb22-731"><a href="#cb22-731"></a><span class="ss">    - </span>Use <span class="in">`difflib`</span> which makes unified diffs.</span>
<span id="cb22-732"><a href="#cb22-732"></a><span class="ss">- </span>I did this, which you will not and should not do - use your own Rust code from class.</span>
<span id="cb22-733"><a href="#cb22-733"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-734"><a href="#cb22-734"></a><span class="in">diff_lines = lambda ls_0, ls_1: [line.rstrip() for line in list(difflib.unified_diff(ls_0, ls_1))]</span></span>
<span id="cb22-735"><a href="#cb22-735"></a><span class="in">```</span></span>
<span id="cb22-736"><a href="#cb22-736"></a><span class="ss">- </span>When you look at the <span class="in">`.scm`</span> files in that repository, the diffs are <span class="in">`-u`</span> diffs, and may appear "messy"</span>
<span id="cb22-737"><a href="#cb22-737"></a></span>
<span id="cb22-738"><a href="#cb22-738"></a><span class="fu">## Aside: `\n`</span></span>
<span id="cb22-739"><a href="#cb22-739"></a></span>
<span id="cb22-740"><a href="#cb22-740"></a><span class="ss">- </span>If you play around with <span class="in">`scm.py`</span> it will explode if you don't have an empty line at the end of your file.</span>
<span id="cb22-741"><a href="#cb22-741"></a><span class="ss">- </span>The combination of <span class="in">`difflib`</span> and <span class="in">`patch`</span> can't handle files that end without a trailing new line.</span>
<span id="cb22-742"><a href="#cb22-742"></a><span class="ss">- </span>This is bad, and your SCM should not contain this bug (and I don't think it will if you do all the steps properly).</span>
<span id="cb22-743"><a href="#cb22-743"></a><span class="ss">    - </span>(Do check)</span>
<span id="cb22-744"><a href="#cb22-744"></a>    </span>
<span id="cb22-745"><a href="#cb22-745"></a><span class="fu">## Build `.scm`</span></span>
<span id="cb22-746"><a href="#cb22-746"></a></span>
<span id="cb22-747"><a href="#cb22-747"></a><span class="ss">- </span>Put all the <span class="in">`diff`</span> in a JSON object / Python Dictionary / Rust <span class="in">`HashMap`</span> / <span class="in">`serde_json::Map`</span></span>
<span id="cb22-748"><a href="#cb22-748"></a><span class="ss">- </span>Overwrite "latest"'s value with all the new versions.</span>
<span id="cb22-749"><a href="#cb22-749"></a><span class="ss">    - </span>We can get the old ones back since we have the diffs.</span>
<span id="cb22-750"><a href="#cb22-750"></a><span class="ss">- </span>Append a entry to "commit" containing an "init" and "diff", either of which may be empty.</span>
<span id="cb22-751"><a href="#cb22-751"></a></span>
<span id="cb22-752"><a href="#cb22-752"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-753"><a href="#cb22-753"></a><span class="in">diff = {f: diff_lines(late[f], open(f).read().splitlines()) for f in old_fs}</span></span>
<span id="cb22-754"><a href="#cb22-754"></a><span class="in">scm["latest"] = {f: open(f).read().splitlines() for f in fs}</span></span>
<span id="cb22-755"><a href="#cb22-755"></a><span class="in">scm["commit"].append({"init": init, "diff": diff})</span></span>
<span id="cb22-756"><a href="#cb22-756"></a><span class="in">```</span></span>
<span id="cb22-757"><a href="#cb22-757"></a></span>
<span id="cb22-758"><a href="#cb22-758"></a><span class="fu">## Update `.scm`</span></span>
<span id="cb22-759"><a href="#cb22-759"></a></span>
<span id="cb22-760"><a href="#cb22-760"></a><span class="ss">- </span>Write to <span class="in">`.scm`</span> using your preferred JSON library...</span>
<span id="cb22-761"><a href="#cb22-761"></a><span class="ss">    - </span>Or do some shenanigans with text files and a nested file system if you are Git-like.</span>
<span id="cb22-762"><a href="#cb22-762"></a><span class="ss">- </span>Manage all your files appropriately and gracefully exit.</span>
<span id="cb22-763"><a href="#cb22-763"></a></span>
<span id="cb22-764"><a href="#cb22-764"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-765"><a href="#cb22-765"></a><span class="in">json.dump(scm, open(SCM_NAME, "w"))</span></span>
<span id="cb22-766"><a href="#cb22-766"></a><span class="in">```</span></span>
<span id="cb22-767"><a href="#cb22-767"></a></span>
<span id="cb22-768"><a href="#cb22-768"></a><span class="ss">- </span>Oh and save your work - I did so using <span class="in">`git commit`</span> - since you will explode your code all the time.</span>
<span id="cb22-769"><a href="#cb22-769"></a></span>
<span id="cb22-770"><a href="#cb22-770"></a><span class="fu">## My Revert</span></span>
<span id="cb22-771"><a href="#cb22-771"></a></span>
<span id="cb22-772"><a href="#cb22-772"></a><span class="ss">- </span>My revert had a dependencies on a nicety, so I will do niceties than return to revert.</span>
<span id="cb22-773"><a href="#cb22-773"></a></span>
<span id="cb22-774"><a href="#cb22-774"></a><span class="fu">## Today</span></span>
<span id="cb22-775"><a href="#cb22-775"></a></span>
<span id="cb22-776"><a href="#cb22-776"></a></span>
<span id="cb22-777"><a href="#cb22-777"></a><span class="ss">- </span>Requirements</span>
<span id="cb22-778"><a href="#cb22-778"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`commit`</span></span>
<span id="cb22-779"><a href="#cb22-779"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`revert`</span></span>
<span id="cb22-780"><a href="#cb22-780"></a><span class="ss">- </span>Nice-to-haves</span>
<span id="cb22-781"><a href="#cb22-781"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`viewer`</span></span>
<span id="cb22-782"><a href="#cb22-782"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`scrape`</span></span>
<span id="cb22-783"><a href="#cb22-783"></a>    </span>
<span id="cb22-784"><a href="#cb22-784"></a><span class="fu"># Niceties</span></span>
<span id="cb22-785"><a href="#cb22-785"></a></span>
<span id="cb22-786"><a href="#cb22-786"></a><span class="fu">## My scrape</span></span>
<span id="cb22-787"><a href="#cb22-787"></a></span>
<span id="cb22-788"><a href="#cb22-788"></a><span class="ss">- </span>When I write code, a lot of times I write bad code.</span>
<span id="cb22-789"><a href="#cb22-789"></a><span class="ss">    - </span>So I delete it.</span>
<span id="cb22-790"><a href="#cb22-790"></a><span class="ss">- </span>This is easier if you happen to working under control/management and can just type <span class="in">`./scm.py scrape`</span> and get back the latest good version.</span>
<span id="cb22-791"><a href="#cb22-791"></a><span class="ss">    - </span>I think of it as "scraping off" my honk-honk-silly-goose era.</span>
<span id="cb22-792"><a href="#cb22-792"></a><span class="ss">- </span>If you aren't doing it already, this could change your life!</span>
<span id="cb22-793"><a href="#cb22-793"></a></span>
<span id="cb22-794"><a href="#cb22-794"></a><span class="fu">## Dependency</span></span>
<span id="cb22-795"><a href="#cb22-795"></a></span>
<span id="cb22-796"><a href="#cb22-796"></a><span class="ss">- </span>It also so happens that to successfully apply a diff, you need to do so against one of the two files that are, well, <span class="in">`diff`</span>'ed.</span>
<span id="cb22-797"><a href="#cb22-797"></a><span class="ss">- </span>The current file version isn't necessarily one of those!</span>
<span id="cb22-798"><a href="#cb22-798"></a><span class="ss">- </span>So keep track of a file version that that can receive a diff, so you can go back further than to the latest commit!</span>
<span id="cb22-799"><a href="#cb22-799"></a></span>
<span id="cb22-800"><a href="#cb22-800"></a><span class="fu">## Easy-mode</span></span>
<span id="cb22-801"><a href="#cb22-801"></a></span>
<span id="cb22-802"><a href="#cb22-802"></a><span class="ss">- </span>I just open <span class="in">`.scm`</span>, and unconditionally write everything in "latest" to the file system.</span>
<span id="cb22-803"><a href="#cb22-803"></a><span class="ss">- </span>It's a single (<span class="in">`black`</span>-exploded) line.</span>
<span id="cb22-804"><a href="#cb22-804"></a><span class="ss">    - </span>I do add a gracefully exit if there's been no commit yet.</span>
<span id="cb22-805"><a href="#cb22-805"></a></span>
<span id="cb22-806"><a href="#cb22-806"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-807"><a href="#cb22-807"></a><span class="in">(not os.path.isfile(SCM_NAME) or os.path.getsize(".scm") == 0) and exit()</span></span>
<span id="cb22-808"><a href="#cb22-808"></a><span class="in">[</span></span>
<span id="cb22-809"><a href="#cb22-809"></a><span class="in">    open(k, "w").write("\n".join(v))</span></span>
<span id="cb22-810"><a href="#cb22-810"></a><span class="in">    for k, v in json.loads(open(SCM_NAME, "r").read())["latest"].items()</span></span>
<span id="cb22-811"><a href="#cb22-811"></a><span class="in">]</span></span>
<span id="cb22-812"><a href="#cb22-812"></a><span class="in">```</span></span>
<span id="cb22-813"><a href="#cb22-813"></a></span>
<span id="cb22-814"><a href="#cb22-814"></a><span class="fu">## Recall</span></span>
<span id="cb22-815"><a href="#cb22-815"></a></span>
<span id="cb22-816"><a href="#cb22-816"></a><span class="ss">- </span>I'm not actually saving block text, I'm only saving lines.</span>
<span id="cb22-817"><a href="#cb22-817"></a><span class="ss">- </span>So when I write to file, I rebuild the text blocks by combining lines with intermediate new-lines.</span>
<span id="cb22-818"><a href="#cb22-818"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-819"><a href="#cb22-819"></a><span class="in">"\n".join(v) # v was "value" - the JSON array of strings (lines)</span></span>
<span id="cb22-820"><a href="#cb22-820"></a><span class="in">```</span></span>
<span id="cb22-821"><a href="#cb22-821"></a><span class="ss">- </span>This is mildly annoying but makes the JSON easier to read, so I did it.</span>
<span id="cb22-822"><a href="#cb22-822"></a><span class="ss">- </span>I highlight this as an example of how you should make your own choices.</span>
<span id="cb22-823"><a href="#cb22-823"></a></span>
<span id="cb22-824"><a href="#cb22-824"></a><span class="fu">## Design Decision</span></span>
<span id="cb22-825"><a href="#cb22-825"></a></span>
<span id="cb22-826"><a href="#cb22-826"></a><span class="ss">- </span>This would be quite difficult (as in your would be recursively applying diffs along the entirety of the <span class="in">`.scm`</span> file) if you did not keep "latest" around.</span>
<span id="cb22-827"><a href="#cb22-827"></a><span class="ss">- </span>Work smart not hard!</span>
<span id="cb22-828"><a href="#cb22-828"></a></span>
<span id="cb22-829"><a href="#cb22-829"></a><span class="fu">## Today</span></span>
<span id="cb22-830"><a href="#cb22-830"></a></span>
<span id="cb22-831"><a href="#cb22-831"></a></span>
<span id="cb22-832"><a href="#cb22-832"></a><span class="ss">- </span>Requirements</span>
<span id="cb22-833"><a href="#cb22-833"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`commit`</span></span>
<span id="cb22-834"><a href="#cb22-834"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`revert`</span></span>
<span id="cb22-835"><a href="#cb22-835"></a><span class="ss">- </span>Nice-to-haves</span>
<span id="cb22-836"><a href="#cb22-836"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`viewer`</span></span>
<span id="cb22-837"><a href="#cb22-837"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`scrape`</span></span>
<span id="cb22-838"><a href="#cb22-838"></a>    </span>
<span id="cb22-839"><a href="#cb22-839"></a><span class="fu"># Requirements</span></span>
<span id="cb22-840"><a href="#cb22-840"></a></span>
<span id="cb22-841"><a href="#cb22-841"></a><span class="fu">## My Revert</span></span>
<span id="cb22-842"><a href="#cb22-842"></a></span>
<span id="cb22-843"><a href="#cb22-843"></a><span class="ss">- </span>Revert isn't too bad once you have a scraper.</span>
<span id="cb22-844"><a href="#cb22-844"></a><span class="ss">    - </span>Scrape, then...</span>
<span id="cb22-845"><a href="#cb22-845"></a><span class="ss">    - </span>Look at the most recent commit, and</span>
<span id="cb22-846"><a href="#cb22-846"></a><span class="ss">    - </span>Look at all its diffs, then</span>
<span id="cb22-847"><a href="#cb22-847"></a><span class="ss">    - </span>Apply them all reverse style (<span class="in">`patch -R`</span>)</span>
<span id="cb22-848"><a href="#cb22-848"></a><span class="ss">    - </span>Pop that commit off the JSON array and rewrite <span class="in">`.scm`</span></span>
<span id="cb22-849"><a href="#cb22-849"></a><span class="ss">        - </span>That is, destroy all traces.</span>
<span id="cb22-850"><a href="#cb22-850"></a><span class="ss">        - </span>(You can keep traces; I didn't want to)</span>
<span id="cb22-851"><a href="#cb22-851"></a></span>
<span id="cb22-852"><a href="#cb22-852"></a><span class="fu">## Get started</span></span>
<span id="cb22-853"><a href="#cb22-853"></a></span>
<span id="cb22-854"><a href="#cb22-854"></a><span class="ss">- </span>Scrape and open <span class="in">`.scm`</span></span>
<span id="cb22-855"><a href="#cb22-855"></a></span>
<span id="cb22-856"><a href="#cb22-856"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-857"><a href="#cb22-857"></a><span class="in">scrape()</span></span>
<span id="cb22-858"><a href="#cb22-858"></a><span class="in">scm = json.loads(open(SCM_NAME, "r").read())</span></span>
<span id="cb22-859"><a href="#cb22-859"></a><span class="in">late = scm["latest"]</span></span>
<span id="cb22-860"><a href="#cb22-860"></a><span class="in">curr = scm["commit"]</span></span>
<span id="cb22-861"><a href="#cb22-861"></a><span class="in">```</span></span>
<span id="cb22-862"><a href="#cb22-862"></a></span>
<span id="cb22-863"><a href="#cb22-863"></a><span class="fu">## Case handling</span></span>
<span id="cb22-864"><a href="#cb22-864"></a></span>
<span id="cb22-865"><a href="#cb22-865"></a><span class="ss">- </span>By the way, you can't revert if you only have one commit.</span>
<span id="cb22-866"><a href="#cb22-866"></a><span class="ss">    - </span>Think about why not!</span>
<span id="cb22-867"><a href="#cb22-867"></a>    </span>
<span id="cb22-868"><a href="#cb22-868"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-869"><a href="#cb22-869"></a><span class="in">len(curr) &lt; 2 and exit()</span></span>
<span id="cb22-870"><a href="#cb22-870"></a><span class="in">```</span></span>
<span id="cb22-871"><a href="#cb22-871"></a></span>
<span id="cb22-872"><a href="#cb22-872"></a><span class="ss">- </span>In general, make some effort to use your SCM as you write it to find this fun little corner cases.</span>
<span id="cb22-873"><a href="#cb22-873"></a></span>
<span id="cb22-874"><a href="#cb22-874"></a></span>
<span id="cb22-875"><a href="#cb22-875"></a><span class="fu">## Pop a commit</span></span>
<span id="cb22-876"><a href="#cb22-876"></a></span>
<span id="cb22-877"><a href="#cb22-877"></a><span class="ss">- </span>I didn't destroy any new files.</span>
<span id="cb22-878"><a href="#cb22-878"></a><span class="ss">- </span>Hard to care about that. Maybe I should?</span>
<span id="cb22-879"><a href="#cb22-879"></a><span class="ss">- </span>So I just look at the "diff" values only, and destructive update the "commit" JSON array.</span>
<span id="cb22-880"><a href="#cb22-880"></a></span>
<span id="cb22-881"><a href="#cb22-881"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-882"><a href="#cb22-882"></a><span class="in">last = curr.pop()["diff"]</span></span>
<span id="cb22-883"><a href="#cb22-883"></a><span class="in">```</span></span>
<span id="cb22-884"><a href="#cb22-884"></a></span>
<span id="cb22-885"><a href="#cb22-885"></a><span class="ss">- </span>This contains all we need to go back in time.</span>
<span id="cb22-886"><a href="#cb22-886"></a></span>
<span id="cb22-887"><a href="#cb22-887"></a><span class="fu">## This is gross</span></span>
<span id="cb22-888"><a href="#cb22-888"></a></span>
<span id="cb22-889"><a href="#cb22-889"></a><span class="ss">- </span>I don't think there's a baseline Python <span class="in">`patch`</span> so I had to hack a bit.</span>
<span id="cb22-890"><a href="#cb22-890"></a><span class="ss">- </span>I throw the diff into the filesystem, use <span class="in">`os.system`</span> to call <span class="in">`patch`</span>, then clean up latter.</span>
<span id="cb22-891"><a href="#cb22-891"></a><span class="ss">- </span>This is bad, don't do this, write <span class="in">`patch`</span> in Rust.</span>
<span id="cb22-892"><a href="#cb22-892"></a><span class="ss">    - </span>It is *very close* to diff!</span>
<span id="cb22-893"><a href="#cb22-893"></a>    </span>
<span id="cb22-894"><a href="#cb22-894"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-895"><a href="#cb22-895"></a><span class="in">for k, v in last.items():</span></span>
<span id="cb22-896"><a href="#cb22-896"></a><span class="in">    open(DIFF_NAME, "w").write("\n".join(v))</span></span>
<span id="cb22-897"><a href="#cb22-897"></a><span class="in">    os.system("patch -R " + k + " " + DIFF_NAME)</span></span>
<span id="cb22-898"><a href="#cb22-898"></a><span class="in">```</span></span>
<span id="cb22-899"><a href="#cb22-899"></a></span>
<span id="cb22-900"><a href="#cb22-900"></a><span class="fu">## Clean up</span></span>
<span id="cb22-901"><a href="#cb22-901"></a></span>
<span id="cb22-902"><a href="#cb22-902"></a><span class="ss">- </span>Rewrite <span class="in">`.scm`</span>, remove <span class="in">`.diff`</span>, and exit gracefully.</span>
<span id="cb22-903"><a href="#cb22-903"></a></span>
<span id="cb22-904"><a href="#cb22-904"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-905"><a href="#cb22-905"></a><span class="in">json.dump(scm, open(SCM_NAME, "w"))</span></span>
<span id="cb22-906"><a href="#cb22-906"></a><span class="in">os.delete(DIFF_NAME)</span></span>
<span id="cb22-907"><a href="#cb22-907"></a><span class="in">```</span></span>
<span id="cb22-908"><a href="#cb22-908"></a></span>
<span id="cb22-909"><a href="#cb22-909"></a><span class="fu">## Understanding check</span></span>
<span id="cb22-910"><a href="#cb22-910"></a></span>
<span id="cb22-911"><a href="#cb22-911"></a><span class="ss">- </span>My revert is wrong and puts the SCM into an unstable state.</span>
<span id="cb22-912"><a href="#cb22-912"></a><span class="ss">- </span>How?</span>
<span id="cb22-913"><a href="#cb22-913"></a></span>
<span id="cb22-914"><a href="#cb22-914"></a><span class="fu">## Answer</span></span>
<span id="cb22-915"><a href="#cb22-915"></a></span>
<span id="cb22-916"><a href="#cb22-916"></a><span class="ss">- </span>I don't rewrite "latest" after a revert!</span>
<span id="cb22-917"><a href="#cb22-917"></a><span class="ss">    - </span>I forgot this and didn't uncover it in testing!</span>
<span id="cb22-918"><a href="#cb22-918"></a><span class="ss">    - </span>Test your code!</span>
<span id="cb22-919"><a href="#cb22-919"></a><span class="ss">    - </span>I just noticed when writing these slides!</span>
<span id="cb22-920"><a href="#cb22-920"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Read me</span><span class="co">](https://github.com/cd-c89/scmpy/issues/1)</span></span>
<span id="cb22-921"><a href="#cb22-921"></a></span>
<span id="cb22-922"><a href="#cb22-922"></a><span class="fu">## Hint</span></span>
<span id="cb22-923"><a href="#cb22-923"></a></span>
<span id="cb22-924"><a href="#cb22-924"></a><span class="ss">- </span>The code to fix this already exists in <span class="in">`scm.py`</span></span>
<span id="cb22-925"><a href="#cb22-925"></a><span class="ss">- </span>It should be factored!</span>
<span id="cb22-926"><a href="#cb22-926"></a></span>
<span id="cb22-927"><a href="#cb22-927"></a><span class="fu">## Today</span></span>
<span id="cb22-928"><a href="#cb22-928"></a></span>
<span id="cb22-929"><a href="#cb22-929"></a><span class="ss">- </span>Requirements</span>
<span id="cb22-930"><a href="#cb22-930"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`commit`</span></span>
<span id="cb22-931"><a href="#cb22-931"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`revert`</span></span>
<span id="cb22-932"><a href="#cb22-932"></a><span class="ss">- </span>Nice-to-haves</span>
<span id="cb22-933"><a href="#cb22-933"></a><span class="ss">    - </span><span class="va">[ ]</span> <span class="in">`viewer`</span></span>
<span id="cb22-934"><a href="#cb22-934"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`scrape`</span></span>
<span id="cb22-935"><a href="#cb22-935"></a>    </span>
<span id="cb22-936"><a href="#cb22-936"></a><span class="fu"># Niceties</span></span>
<span id="cb22-937"><a href="#cb22-937"></a></span>
<span id="cb22-938"><a href="#cb22-938"></a><span class="fu">## My Viewer</span></span>
<span id="cb22-939"><a href="#cb22-939"></a></span>
<span id="cb22-940"><a href="#cb22-940"></a><span class="ss">- </span>I don't think pretty-print is interesting, but...</span>
<span id="cb22-941"><a href="#cb22-941"></a><span class="ss">- </span>We did play around with it a bit on Wordle, and it can be fun.</span>
<span id="cb22-942"><a href="#cb22-942"></a><span class="ss">- </span>Engage at your own discretion.</span>
<span id="cb22-943"><a href="#cb22-943"></a><span class="ss">- </span>Just got tired of using <span class="in">`python3 -m json-tool`</span> and it was ugly so I played around a bit.</span>
<span id="cb22-944"><a href="#cb22-944"></a></span>
<span id="cb22-945"><a href="#cb22-945"></a><span class="fu">## I just use `jq`</span></span>
<span id="cb22-946"><a href="#cb22-946"></a></span>
<span id="cb22-947"><a href="#cb22-947"></a><span class="ss">- </span>I hear just about every system has <span class="in">`jq`</span> on it.</span>
<span id="cb22-948"><a href="#cb22-948"></a></span>
<span id="cb22-949"><a href="#cb22-949"></a><span class="in">```{.py filename="scm.py"}</span></span>
<span id="cb22-950"><a href="#cb22-950"></a><span class="in">viewer = lambda: os.system(</span></span>
<span id="cb22-951"><a href="#cb22-951"></a><span class="in">    "jq . .scm"</span></span>
<span id="cb22-952"><a href="#cb22-952"></a><span class="in">)  # print(json.dumps(json.load(open(SCM_NAME)), indent=4))</span></span>
<span id="cb22-953"><a href="#cb22-953"></a><span class="in">```</span></span>
<span id="cb22-954"><a href="#cb22-954"></a></span>
<span id="cb22-955"><a href="#cb22-955"></a><span class="ss">- </span>And if not I just used <span class="in">`json`</span>, so</span>
<span id="cb22-956"><a href="#cb22-956"></a><span class="ss">- </span>Anyways, if you don't use JSON, you have to write something yourself.</span>
<span id="cb22-957"><a href="#cb22-957"></a><span class="ss">    - </span>It must show what a previous version would look like, some how.</span>
<span id="cb22-958"><a href="#cb22-958"></a>    </span>
<span id="cb22-959"><a href="#cb22-959"></a><span class="fu">## `git show --stat`</span></span>
<span id="cb22-960"><a href="#cb22-960"></a></span>
<span id="cb22-961"><a href="#cb22-961"></a><span class="ss">- </span>I don't love this.</span>
<span id="cb22-962"><a href="#cb22-962"></a><span class="ss">    - </span>Can't tell *what* the changes are, but...</span>
<span id="cb22-963"><a href="#cb22-963"></a><span class="ss">    - </span>It is good enough if you don't go the JSON route.</span>
<span id="cb22-964"><a href="#cb22-964"></a></span>
<span id="cb22-965"><a href="#cb22-965"></a><span class="in">```{.sh}</span></span>
<span id="cb22-966"><a href="#cb22-966"></a><span class="in">$ git show --stat</span></span>
<span id="cb22-967"><a href="#cb22-967"></a><span class="in">commit 9b1cd0fc410b50a25370b5bcaa57ceb407e51bff (HEAD -&gt; main, origin/main, origin/HEAD)</span></span>
<span id="cb22-968"><a href="#cb22-968"></a><span class="in">Author: c &lt;ckdeutschbein@willamette.edu&gt;</span></span>
<span id="cb22-969"><a href="#cb22-969"></a><span class="in">Date:   Sat Nov 29 12:44:40 2025 -0800</span></span>
<span id="cb22-970"><a href="#cb22-970"></a></span>
<span id="cb22-971"><a href="#cb22-971"></a><span class="in">    think this is good enough</span></span>
<span id="cb22-972"><a href="#cb22-972"></a></span>
<span id="cb22-973"><a href="#cb22-973"></a><span class="in"> .scm   | 2 +-</span></span>
<span id="cb22-974"><a href="#cb22-974"></a><span class="in"> scm.py | 8 ++++----</span></span>
<span id="cb22-975"><a href="#cb22-975"></a><span class="in"> 2 files changed, 5 insertions(+), 5 deletions(-)</span></span>
<span id="cb22-976"><a href="#cb22-976"></a><span class="in">```</span></span>
<span id="cb22-977"><a href="#cb22-977"></a></span>
<span id="cb22-978"><a href="#cb22-978"></a><span class="fu">## Minimal</span></span>
<span id="cb22-979"><a href="#cb22-979"></a></span>
<span id="cb22-980"><a href="#cb22-980"></a><span class="ss">- </span>First 3 lines are of course hash stuff, and now optional.</span>
<span id="cb22-981"><a href="#cb22-981"></a><span class="ss">- </span>Next line is a commit message, which I didn't require (or even support, though it would be trivial to do so)</span>
<span id="cb22-982"><a href="#cb22-982"></a><span class="ss">- </span>This would be fine for the final.</span>
<span id="cb22-983"><a href="#cb22-983"></a></span>
<span id="cb22-984"><a href="#cb22-984"></a><span class="in">```{.sh}</span></span>
<span id="cb22-985"><a href="#cb22-985"></a><span class="in">$ ./scm viewer # assuming you name your binary `scm`</span></span>
<span id="cb22-986"><a href="#cb22-986"></a><span class="in">.scm   | 2 +-</span></span>
<span id="cb22-987"><a href="#cb22-987"></a><span class="in">scm.py | 8 ++++----</span></span>
<span id="cb22-988"><a href="#cb22-988"></a><span class="in">```</span></span>
<span id="cb22-989"><a href="#cb22-989"></a></span>
<span id="cb22-990"><a href="#cb22-990"></a><span class="fu">## Today</span></span>
<span id="cb22-991"><a href="#cb22-991"></a></span>
<span id="cb22-992"><a href="#cb22-992"></a><span class="ss">- </span>Requirements</span>
<span id="cb22-993"><a href="#cb22-993"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`commit`</span></span>
<span id="cb22-994"><a href="#cb22-994"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`revert`</span></span>
<span id="cb22-995"><a href="#cb22-995"></a><span class="ss">- </span>Nice-to-haves</span>
<span id="cb22-996"><a href="#cb22-996"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`viewer`</span></span>
<span id="cb22-997"><a href="#cb22-997"></a><span class="ss">    - </span><span class="va">[x]</span> <span class="in">`scrape`</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>